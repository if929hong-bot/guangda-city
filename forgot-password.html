<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>忘記密碼 - 廣大城租客管理系統</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* 基礎樣式繼承系統風格 */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Microsoft JhengHei', sans-serif;
    }
    body {
      background-color: #f5f7fa;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }
    .auth-container {
      background: white;
      width: 100%;
      max-width: 500px;
      border-radius: 10px;
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    .auth-header {
      background-color: #1f4e8c;
      color: white;
      padding: 20px;
      text-align: center;
    }
    .auth-header h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }
    .auth-header p {
      font-size: 14px;
      opacity: 0.9;
    }
    .auth-body {
      padding: 30px;
    }
    .form-step {
      display: none; /* 預設隱藏所有步驟 */
    }
    .form-step.active {
      display: block; /* 當前步驟顯示 */
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      color: #333;
      font-weight: 500;
    }
    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    .form-control:focus {
      outline: none;
      border-color: #1f4e8c;
      box-shadow: 0 0 0 2px rgba(31, 78, 140, 0.1);
    }
    .form-note {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
    .btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .btn-primary {
      background-color: #1f4e8c;
      color: white;
    }
    .btn-primary:hover {
      background-color: #184078;
    }
    .btn-secondary {
      background-color: #6c757d;
      color: white;
      margin-top: 10px;
    }
    .btn-secondary:hover {
      background-color: #5a6268;
    }
    .verification-code {
      display: flex;
      gap: 10px;
    }
    .verification-code input {
      flex: 1;
      text-align: center;
      font-size: 20px;
      letter-spacing: 2px;
    }
    .timer {
      font-size: 14px;
      color: #dc3545;
      text-align: center;
      margin: 10px 0;
    }
    .resend-code {
      text-align: center;
      margin: 10px 0;
    }
    .resend-code a {
      color: #1f4e8c;
      text-decoration: none;
      font-size: 14px;
    }
    .resend-code a:hover {
      text-decoration: underline;
    }
    .success-message {
      text-align: center;
      padding: 20px 0;
    }
    .success-icon {
      font-size: 60px;
      color: #28a745;
      margin-bottom: 15px;
    }
    .success-message h3 {
      font-size: 20px;
      color: #333;
      margin-bottom: 10px;
    }
    .success-message p {
      color: #666;
      margin-bottom: 20px;
    }
    /* 錯誤提示 */
    .error-message {
      color: #dc3545;
      font-size: 13px;
      margin-top: 5px;
      display: none;
    }
    .form-control.error {
      border-color: #dc3545;
    }
  </style>
</head>
<body>
  <div class="auth-container">
    <!-- 頁頭 -->
    <div class="auth-header">
      <h1><i class="fa-solid fa-key"></i> 忘記密碼</h1>
      <p>透過手機驗證重置您的密碼</p>
    </div>

    <!-- 表單主體 -->
    <div class="auth-body">
      <!-- 步驟1：輸入手機號 -->
      <div class="form-step active" id="step1">
        <div class="form-group">
          <label for="phone"><i class="fa-solid fa-mobile-screen-button"></i> 註冊手機號</label>
          <input type="tel" id="phone" class="form-control" placeholder="請輸入您註冊時使用的手機號" maxlength="10">
          <div class="error-message" id="phoneError">手機號格式錯誤或未註冊</div>
          <div class="form-note">請輸入10位數的台灣手機號（例：0912345678）</div>
        </div>
        <button class="btn btn-primary" id="sendCodeBtn">發送驗證碼</button>
        <button class="btn btn-secondary" onclick="window.location.href='index.html'">返回登入</button>
      </div>

      <!-- 步驟2：驗證碼驗證 -->
      <div class="form-step" id="step2">
        <div class="form-group">
          <label><i class="fa-solid fa-shield-halved"></i> 驗證碼</label>
          <div class="verification-code">
            <input type="text" class="form-control" id="code1" maxlength="1" oninput="nextInput(this, 'code2')">
            <input type="text" class="form-control" id="code2" maxlength="1" oninput="nextInput(this, 'code3')">
            <input type="text" class="form-control" id="code3" maxlength="1" oninput="nextInput(this, 'code4')">
            <input type="text" class="form-control" id="code4" maxlength="1" oninput="nextInput(this, 'code5')">
            <input type="text" class="form-control" id="code5" maxlength="1" oninput="nextInput(this, 'code6')">
            <input type="text" class="form-control" id="code6" maxlength="1" oninput="checkCodeComplete()">
          </div>
          <div class="error-message" id="codeError">驗證碼錯誤</div>
          <div class="timer" id="timer">驗證碼將在 <span id="countdown">60</span> 秒後過期</div>
          <div class="resend-code">
            <a href="javascript:void(0)" id="resendCodeBtn" style="display: none;" onclick="resendVerificationCode()">重新發送驗證碼</a>
          </div>
        </div>
        <button class="btn btn-primary" id="verifyCodeBtn">驗證</button>
        <button class="btn btn-secondary" onclick="backToStep1()">返回上一步</button>
      </div>

      <!-- 步驟3：重置密碼 -->
      <div class="form-step" id="step3">
        <div class="form-group">
          <label for="newPassword"><i class="fa-solid fa-lock"></i> 新密碼</label>
          <input type="password" id="newPassword" class="form-control" placeholder="請輸入新密碼" minlength="6">
          <div class="error-message" id="passwordError">密碼長度需至少6位</div>
          <div class="form-note">密碼長度至少6位，建議包含數字和字母</div>
        </div>
        <div class="form-group">
          <label for="confirmPassword"><i class="fa-solid fa-lock"></i> 確認新密碼</label>
          <input type="password" id="confirmPassword" class="form-control" placeholder="請再次輸入新密碼">
          <div class="error-message" id="confirmError">兩次密碼輸入不一致</div>
        </div>
        <button class="btn btn-primary" id="resetPasswordBtn">重置密碼</button>
        <button class="btn btn-secondary" onclick="backToStep2()">返回上一步</button>
      </div>

      <!-- 步驟4：重置成功 -->
      <div class="form-step" id="step4">
        <div class="success-message">
          <div class="success-icon"><i class="fa-solid fa-circle-check"></i></div>
          <h3>密碼重置成功！</h3>
          <p>您的密碼已更新，請使用新密碼登入</p>
          <button class="btn btn-primary" onclick="window.location.href='index.html'">前往登入</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 全局變量
    let verificationCode = ''; // 隨機生成的驗證碼
    let countdownTimer = null; // 倒計時定時器
    let currentPhone = ''; // 當前驗證的手機號

    // 步驟切換函數
    function showStep(stepId) {
      // 隱藏所有步驟
      document.querySelectorAll('.form-step').forEach(step => {
        step.classList.remove('active');
      });
      // 顯示當前步驟
      document.getElementById(stepId).classList.add('active');
    }

    // 輸入驗證碼自動跳轉下一個輸入框
    function nextInput(current, nextId) {
      if (current.value) {
        document.getElementById(nextId).focus();
      }
    }

    // 檢查驗證碼是否填寫完成
    function checkCodeComplete() {
      const code1 = document.getElementById('code1').value;
      const code2 = document.getElementById('code2').value;
      const code3 = document.getElementById('code3').value;
      const code4 = document.getElementById('code4').value;
      const code5 = document.getElementById('code5').value;
      const code6 = document.getElementById('code6').value;
      
      if (code1 && code2 && code3 && code4 && code5 && code6) {
        document.getElementById('verifyCodeBtn').focus();
      }
    }

    // 返回步驟1
    function backToStep1() {
      showStep('step1');
      // 清除倒計時
      if (countdownTimer) {
        clearInterval(countdownTimer);
        countdownTimer = null;
      }
      // 重置驗證碼輸入框
      document.getElementById('code1').value = '';
      document.getElementById('code2').value = '';
      document.getElementById('code3').value = '';
      document.getElementById('code4').value = '';
      document.getElementById('code5').value = '';
      document.getElementById('code6').value = '';
      // 隱藏錯誤提示
      hideError('codeError');
    }

    // 返回步驟2
    function backToStep2() {
      showStep('step2');
      // 隱藏密碼錯誤提示
      hideError('passwordError');
      hideError('confirmError');
    }

    // 顯示錯誤提示
    function showError(elementId) {
      document.getElementById(elementId).style.display = 'block';
      // 給輸入框添加錯誤樣式
      const inputId = elementId.replace('Error', '');
      if (document.getElementById(inputId)) {
        document.getElementById(inputId).classList.add('error');
      }
    }

    // 隱藏錯誤提示
    function hideError(elementId) {
      document.getElementById(elementId).style.display = 'none';
      // 移除輸入框錯誤樣式
      const inputId = elementId.replace('Error', '');
      if (document.getElementById(inputId)) {
        document.getElementById(inputId).classList.remove('error');
      }
    }

    // 生成6位隨機驗證碼
    function generateVerificationCode() {
      const code = Math.floor(100000 + Math.random() * 900000).toString();
      verificationCode = code;
      console.log('當前驗證碼：', code); // 測試用，實際專案可移除
      return code;
    }

    // 倒計時函數
    function startCountdown() {
      let seconds = 60;
      const countdownEl = document.getElementById('countdown');
      const resendBtn = document.getElementById('resendCodeBtn');
      
      // 禁用重發按鈕
      resendBtn.style.display = 'none';
      
      // 啟動倒計時
      countdownTimer = setInterval(() => {
        seconds--;
        countdownEl.textContent = seconds;
        
        if (seconds <= 0) {
          clearInterval(countdownTimer);
          countdownTimer = null;
          countdownEl.textContent = '0';
          resendBtn.style.display = 'inline'; // 顯示重新發送按鈕
        }
      }, 1000);
    }

    // 發送驗證碼
    document.getElementById('sendCodeBtn').addEventListener('click', () => {
      const phone = document.getElementById('phone').value.trim();
      hideError('phoneError');

      // 驗證手機號格式（台灣手機號：09開頭，10位數）
      const phoneRegex = /^09\d{8}$/;
      if (!phoneRegex.test(phone)) {
        showError('phoneError');
        document.getElementById('phoneError').textContent = '請輸入有效的台灣手機號（09開頭，10位數）';
        return;
      }

      // 檢查手機號是否已註冊
      const tenants = JSON.parse(localStorage.getItem('gdcTenants')) || [];
      const tenant = tenants.find(t => t.phone === phone);
      if (!tenant) {
        showError('phoneError');
        document.getElementById('phoneError').textContent = '該手機號尚未註冊';
        return;
      }

      // 保存當前手機號
      currentPhone = phone;
      
      // 生成驗證碼
      generateVerificationCode();
      
      // 模擬發送驗證碼（實際專案替換為後端接口）
      alert(`驗證碼已發送至手機 ${phone}：${verificationCode}（測試用）`);
      
      // 啟動倒計時
      startCountdown();
      
      // 切換到步驟2
      showStep('step2');
      // 焦點定位到第一個驗證碼輸入框
      document.getElementById('code1').focus();
    });

    // 重新發送驗證碼
    function resendVerificationCode() {
      // 生成新的驗證碼
      generateVerificationCode();
      
      // 模擬重新發送
      alert(`新的驗證碼已發送至手機 ${currentPhone}：${verificationCode}（測試用）`);
      
      // 重新啟動倒計時
      startCountdown();
    }

    // 驗證驗證碼
    document.getElementById('verifyCodeBtn').addEventListener('click', () => {
      const code1 = document.getElementById('code1').value;
      const code2 = document.getElementById('code2').value;
      const code3 = document.getElementById('code3').value;
      const code4 = document.getElementById('code4').value;
      const code5 = document.getElementById('code5').value;
      const code6 = document.getElementById('code6').value;
      
      const inputCode = code1 + code2 + code3 + code4 + code5 + code6;
      hideError('codeError');

      // 驗證驗證碼
      if (inputCode !== verificationCode) {
        showError('codeError');
        return;
      }

      // 驗證通過，切換到步驟3
      showStep('step3');
    });

    // 重置密碼
    document.getElementById('resetPasswordBtn').addEventListener('click', () => {
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      hideError('passwordError');
      hideError('confirmError');

      // 驗證密碼長度
      if (newPassword.length < 6) {
        showError('passwordError');
        return;
      }

      // 驗證兩次密碼是否一致
      if (newPassword !== confirmPassword) {
        showError('confirmError');
        return;
      }

      // 更新本地存儲中的密碼
      const tenants = JSON.parse(localStorage.getItem('gdcTenants')) || [];
      const updatedTenants = tenants.map(tenant => {
        if (tenant.phone === currentPhone) {
          return { ...tenant, password: newPassword }; // 重置密碼
        }
        return tenant;
      });

      // 保存更新後的數據
      localStorage.setItem('gdcTenants', JSON.stringify(updatedTenants));
      
      // 切換到成功頁面
      showStep('step4');
    });

    // 手機號輸入格式校驗（僅數字）
    document.getElementById('phone').addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/\D/g, ''); // 移除非數字字符
    });

    // 驗證碼輸入格式校驗（僅數字）
    const codeInputs = ['code1', 'code2', 'code3', 'code4', 'code5', 'code6'];
    codeInputs.forEach(id => {
      document.getElementById(id).addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/\D/g, ''); // 移除非數字字符
      });
    });
  </script>
</body>
</html>