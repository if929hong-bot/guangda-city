<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¿˜è¨˜å¯†ç¢¼ - å»£å¤§åŸç§Ÿå®¢ç®¡ç†ç³»çµ±</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* åŸºç¤æ¨£å¼ç¹¼æ‰¿ç³»çµ±é¢¨æ ¼ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Microsoft JhengHei', sans-serif;
    }
    body {
      background-color: #f5f7fa;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }
    .auth-container {
      background: white;
      width: 100%;
      max-width: 500px;
      border-radius: 10px;
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    .auth-header {
      background-color: #1f4e8c;
      color: white;
      padding: 20px;
      text-align: center;
    }
    .auth-header h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }
    .auth-header p {
      font-size: 14px;
      opacity: 0.9;
    }
    .auth-body {
      padding: 30px;
    }
    .form-step {
      display: none; /* é è¨­éš±è—æ‰€æœ‰æ­¥é©Ÿ */
    }
    .form-step.active {
      display: block; /* ç•¶å‰æ­¥é©Ÿé¡¯ç¤º */
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      color: #333;
      font-weight: 500;
    }
    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    .form-control:focus {
      outline: none;
      border-color: #1f4e8c;
      box-shadow: 0 0 0 2px rgba(31, 78, 140, 0.1);
    }
    .form-note {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
    .btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .btn-primary {
      background-color: #1f4e8c;
      color: white;
    }
    .btn-primary:hover {
      background-color: #184078;
    }
    .btn-secondary {
      background-color: #6c757d;
      color: white;
      margin-top: 10px;
    }
    .btn-secondary:hover {
      background-color: #5a6268;
    }
    .verification-code {
      display: flex;
      gap: 10px;
    }
    .verification-code input {
      flex: 1;
      text-align: center;
      font-size: 20px;
      letter-spacing: 2px;
    }
    .timer {
      font-size: 14px;
      color: #dc3545;
      text-align: center;
      margin: 10px 0;
    }
    .resend-code {
      text-align: center;
      margin: 10px 0;
    }
    .resend-code a {
      color: #1f4e8c;
      text-decoration: none;
      font-size: 14px;
    }
    .resend-code a:hover {
      text-decoration: underline;
    }
    .success-message {
      text-align: center;
      padding: 20px 0;
    }
    .success-icon {
      font-size: 60px;
      color: #28a745;
      margin-bottom: 15px;
    }
    .success-message h3 {
      font-size: 20px;
      color: #333;
      margin-bottom: 10px;
    }
    .success-message p {
      color: #666;
      margin-bottom: 20px;
    }
    /* éŒ¯èª¤æç¤º */
    .error-message {
      color: #dc3545;
      font-size: 13px;
      margin-top: 5px;
      display: none;
    }
    .form-control.error {
      border-color: #dc3545;
    }
  </style>
</head>
<body>
  <div class="auth-container">
    <!-- é é ­ -->
    <div class="auth-header">
      <h1><i class="fa-solid fa-key"></i> å¿˜è¨˜å¯†ç¢¼</h1>
      <p>é€éä¿¡ç®±é©—è­‰é‡ç½®æ‚¨çš„å¯†ç¢¼</p>
    </div>

    <!-- è¡¨å–®ä¸»é«” -->
    <div class="auth-body">
      <!-- æ­¥é©Ÿ1ï¼šè¼¸å…¥ä¿¡ç®± -->
      <div class="form-step active" id="step1">
        <div class="form-group">
          <label for="email"><i class="fa-solid fa-envelope"></i> è¨»å†Šä¿¡ç®±</label>
          <input type="email" id="email" class="form-control" placeholder="è«‹è¼¸å…¥æ‚¨è¨»å†Šæ™‚ä½¿ç”¨çš„ä¿¡ç®±" >
          <div class="error-message" id="emailError">ä¿¡ç®±æ ¼å¼éŒ¯èª¤æˆ–æœªè¨»å†Š</div>
          <div class="form-note">è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»å­ä¿¡ç®±ï¼ˆä¾‹ï¼šuser@example.comï¼‰</div>
        </div>
        <button class="btn btn-primary" id="sendCodeBtn">ç™¼é€é©—è­‰ç¢¼</button>
        <button class="btn btn-secondary" onclick="window.location.href='index.html'">è¿”å›ç™»å…¥</button>
      </div>

      <!-- æ­¥é©Ÿ2ï¼šé©—è­‰ç¢¼é©—è­‰ -->
      <div class="form-step" id="step2">
        <div class="form-group">
          <label><i class="fa-solid fa-shield-halved"></i> é©—è­‰ç¢¼</label>
          <div class="verification-code">
            <input type="text" class="form-control" id="code1" maxlength="1" oninput="nextInput(this, 'code2')">
            <input type="text" class="form-control" id="code2" maxlength="1" oninput="nextInput(this, 'code3')">
            <input type="text" class="form-control" id="code3" maxlength="1" oninput="nextInput(this, 'code4')">
            <input type="text" class="form-control" id="code4" maxlength="1" oninput="nextInput(this, 'code5')">
            <input type="text" class="form-control" id="code5" maxlength="1" oninput="nextInput(this, 'code6')">
            <input type="text" class="form-control" id="code6" maxlength="1" oninput="checkCodeComplete()">
          </div>
          <div class="error-message" id="codeError">é©—è­‰ç¢¼éŒ¯èª¤</div>
          <div class="timer" id="timer">é©—è­‰ç¢¼å°‡åœ¨ <span id="countdown">60</span> ç§’å¾ŒéæœŸ</div>
          <div class="resend-code">
            <a href="javascript:void(0)" id="resendCodeBtn" style="display: none;" onclick="resendVerificationCode()">é‡æ–°ç™¼é€é©—è­‰ç¢¼</a>
          </div>
        </div>
        <button class="btn btn-primary" id="verifyCodeBtn">é©—è­‰</button>
        <button class="btn btn-secondary" onclick="backToStep1()">è¿”å›ä¸Šä¸€æ­¥</button>
      </div>

      <!-- æ­¥é©Ÿ3ï¼šé‡ç½®å¯†ç¢¼ -->
      <div class="form-step" id="step3">
        <div class="form-group">
          <label for="newPassword"><i class="fa-solid fa-lock"></i> æ–°å¯†ç¢¼</label>
          <input type="password" id="newPassword" class="form-control" placeholder="è«‹è¼¸å…¥æ–°å¯†ç¢¼" minlength="6">
          <div class="error-message" id="passwordError">å¯†ç¢¼é•·åº¦éœ€è‡³å°‘6ä½</div>
          <div class="form-note">å¯†ç¢¼é•·åº¦è‡³å°‘6ä½ï¼Œå»ºè­°åŒ…å«æ•¸å­—å’Œå­—æ¯</div>
        </div>
        <div class="form-group">
          <label for="confirmPassword"><i class="fa-solid fa-lock"></i> ç¢ºèªæ–°å¯†ç¢¼</label>
          <input type="password" id="confirmPassword" class="form-control" placeholder="è«‹å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼">
          <div class="error-message" id="confirmError">å…©æ¬¡å¯†ç¢¼è¼¸å…¥ä¸ä¸€è‡´</div>
        </div>
        <button class="btn btn-primary" id="resetPasswordBtn">é‡ç½®å¯†ç¢¼</button>
        <button class="btn btn-secondary" onclick="backToStep2()">è¿”å›ä¸Šä¸€æ­¥</button>
      </div>

      <!-- æ­¥é©Ÿ4ï¼šé‡ç½®æˆåŠŸ -->
      <div class="form-step" id="step4">
        <div class="success-message">
          <div class="success-icon"><i class="fa-solid fa-circle-check"></i></div>
          <h3>å¯†ç¢¼é‡ç½®æˆåŠŸï¼</h3>
          <p>æ‚¨çš„å¯†ç¢¼å·²æ›´æ–°ï¼Œè«‹ä½¿ç”¨æ–°å¯†ç¢¼ç™»å…¥</p>
          <button class="btn btn-primary" onclick="window.location.href='index.html'">å‰å¾€ç™»å…¥</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // å…¨å±€è®Šé‡
    let verificationCode = ''; // éš¨æ©Ÿç”Ÿæˆçš„é©—è­‰ç¢¼
    let countdownTimer = null; // å€’è¨ˆæ™‚å®šæ™‚å™¨
    let currentEmail = ''; // ç•¶å‰é©—è­‰çš„ä¿¡ç®±

    // æ­¥é©Ÿåˆ‡æ›å‡½æ•¸
    function showStep(stepId) {
      // éš±è—æ‰€æœ‰æ­¥é©Ÿ
      document.querySelectorAll('.form-step').forEach(step => {
        step.classList.remove('active');
      });
      // é¡¯ç¤ºç•¶å‰æ­¥é©Ÿ
      document.getElementById(stepId).classList.add('active');
    }

    // è¼¸å…¥é©—è­‰ç¢¼è‡ªå‹•è·³è½‰ä¸‹ä¸€å€‹è¼¸å…¥æ¡†
    function nextInput(current, nextId) {
      if (current.value) {
        document.getElementById(nextId).focus();
      }
    }

    // æª¢æŸ¥é©—è­‰ç¢¼æ˜¯å¦å¡«å¯«å®Œæˆ
    function checkCodeComplete() {
      const code1 = document.getElementById('code1').value;
      const code2 = document.getElementById('code2').value;
      const code3 = document.getElementById('code3').value;
      const code4 = document.getElementById('code4').value;
      const code5 = document.getElementById('code5').value;
      const code6 = document.getElementById('code6').value;
      
      if (code1 && code2 && code3 && code4 && code5 && code6) {
        document.getElementById('verifyCodeBtn').focus();
      }
    }

    // è¿”å›æ­¥é©Ÿ1
    function backToStep1() {
      showStep('step1');
      // æ¸…é™¤å€’è¨ˆæ™‚
      if (countdownTimer) {
        clearInterval(countdownTimer);
        countdownTimer = null;
      }
      // é‡ç½®é©—è­‰ç¢¼è¼¸å…¥æ¡†
      document.getElementById('code1').value = '';
      document.getElementById('code2').value = '';
      document.getElementById('code3').value = '';
      document.getElementById('code4').value = '';
      document.getElementById('code5').value = '';
      document.getElementById('code6').value = '';
      // éš±è—éŒ¯èª¤æç¤º
      hideError('codeError');
    }

    // è¿”å›æ­¥é©Ÿ2
    function backToStep2() {
      showStep('step2');
      // éš±è—å¯†ç¢¼éŒ¯èª¤æç¤º
      hideError('passwordError');
      hideError('confirmError');
    }

    // é¡¯ç¤ºéŒ¯èª¤æç¤º
    function showError(elementId) {
      document.getElementById(elementId).style.display = 'block';
      // çµ¦è¼¸å…¥æ¡†æ·»åŠ éŒ¯èª¤æ¨£å¼
      const inputId = elementId.replace('Error', '');
      if (document.getElementById(inputId)) {
        document.getElementById(inputId).classList.add('error');
      }
    }

    // éš±è—éŒ¯èª¤æç¤º
    function hideError(elementId) {
      document.getElementById(elementId).style.display = 'none';
      // ç§»é™¤è¼¸å…¥æ¡†éŒ¯èª¤æ¨£å¼
      const inputId = elementId.replace('Error', '');
      if (document.getElementById(inputId)) {
        document.getElementById(inputId).classList.remove('error');
      }
    }

    // ç”Ÿæˆ6ä½éš¨æ©Ÿé©—è­‰ç¢¼
    function generateVerificationCode() {
      const code = Math.floor(100000 + Math.random() * 900000).toString();
      verificationCode = code;
      console.log('ç•¶å‰é©—è­‰ç¢¼ï¼š', code); // æ¸¬è©¦ç”¨ï¼Œå¯¦éš›å°ˆæ¡ˆå¯ç§»é™¤
      return code;
    }

    // å€’è¨ˆæ™‚å‡½æ•¸
    function startCountdown() {
      let seconds = 60;
      const countdownEl = document.getElementById('countdown');
      const resendBtn = document.getElementById('resendCodeBtn');
      
      // ç¦ç”¨é‡ç™¼æŒ‰éˆ•
      resendBtn.style.display = 'none';
      
      // å•Ÿå‹•å€’è¨ˆæ™‚
      countdownTimer = setInterval(() => {
        seconds--;
        countdownEl.textContent = seconds;
        
        if (seconds <= 0) {
          clearInterval(countdownTimer);
          countdownTimer = null;
          countdownEl.textContent = '0';
          resendBtn.style.display = 'inline'; // é¡¯ç¤ºé‡æ–°ç™¼é€æŒ‰éˆ•
        }
      }, 1000);
    }

    // ç™¼é€é©—è­‰ç¢¼ï¼ˆä¿¡ç®±ç‰ˆï¼‰
    document.getElementById('sendCodeBtn').addEventListener('click', () => {
      const email = document.getElementById('email').value.trim();
      hideError('emailError');

      // é©—è­‰ä¿¡ç®±æ ¼å¼
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showError('emailError');
        document.getElementById('emailError').textContent = 'è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»å­ä¿¡ç®±';
        return;
      }

      // æª¢æŸ¥ä¿¡ç®±æ˜¯å¦å·²è¨»å†Š
      const tenants = JSON.parse(localStorage.getItem('gdcTenants')) || [];
      const tenant = tenants.find(t => t.email === email); // åŒ¹é…è¨»å†Šä¿¡ç®±
      if (!tenant) {
        showError('emailError');
        document.getElementById('emailError').textContent = 'è©²ä¿¡ç®±å°šæœªè¨»å†Š';
        return;
      }

      // ä¿å­˜ç•¶å‰ä¿¡ç®±
      currentEmail = email;
      
      // ç”Ÿæˆé©—è­‰ç¢¼
      generateVerificationCode();
      
      // ğŸŒŸ ä¿®æ”¹é»1ï¼šå½ˆçª—åªé¡¯ç¤ºä¿¡ç®±ï¼Œç§»é™¤é©—è­‰ç¢¼é¡¯ç¤º
      alert(`é©—è­‰ç¢¼å·²ç™¼é€è‡³ä¿¡ç®±ï¼š${email}ï¼Œè«‹æŸ¥æ”¶å¾Œè¼¸å…¥`);
      
      // ğŸ“Œ é‡è¦ï¼šé€™è£¡æ˜¯æ¨¡æ“¬ç™¼é€ï¼å¯¦éš›éœ€è¦æ›¿æ›ç‚ºå¾Œç«¯éƒµä»¶æ¥å£ï¼ˆè§£æ±ºæ”¶ä¸åˆ°éƒµä»¶çš„å•é¡Œï¼‰
      // ç¤ºä¾‹å¾Œç«¯è«‹æ±‚ï¼ˆéœ€è¦æ ¹æ“šä½ çš„å¾Œç«¯èªè¨€èª¿æ•´ï¼‰ï¼š
      /*
      fetch('/api/send-verification-code', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: currentEmail, code: verificationCode })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert(`é©—è­‰ç¢¼å·²ç™¼é€è‡³ä¿¡ç®±ï¼š${email}ï¼Œè«‹æŸ¥æ”¶å¾Œè¼¸å…¥`);
        } else {
          alert('é©—è­‰ç¢¼ç™¼é€å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦');
        }
      })
      .catch(err => {
        console.error('éƒµä»¶ç™¼é€éŒ¯èª¤ï¼š', err);
        alert('é©—è­‰ç¢¼ç™¼é€å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦');
      });
      */
      
      // å•Ÿå‹•å€’è¨ˆæ™‚
      startCountdown();
      
      // åˆ‡æ›åˆ°æ­¥é©Ÿ2
      showStep('step2');
      // ç„¦é»å®šä½åˆ°ç¬¬ä¸€å€‹é©—è­‰ç¢¼è¼¸å…¥æ¡†
      document.getElementById('code1').focus();
    });

    // é‡æ–°ç™¼é€é©—è­‰ç¢¼
    function resendVerificationCode() {
      // ç”Ÿæˆæ–°çš„é©—è­‰ç¢¼
      generateVerificationCode();
      
      // ğŸŒŸ ä¿®æ”¹é»2ï¼šé‡æ–°ç™¼é€çš„å½ˆçª—ä¹Ÿéš±è—é©—è­‰ç¢¼
      alert(`æ–°çš„é©—è­‰ç¢¼å·²ç™¼é€è‡³ä¿¡ç®±ï¼š${currentEmail}ï¼Œè«‹æŸ¥æ”¶å¾Œè¼¸å…¥`);
      
      // ğŸ“Œ åŒæ¨£éœ€è¦æ›¿æ›ç‚ºçœŸå¯¦å¾Œç«¯æ¥å£ï¼ˆé‡æ–°ç™¼é€ï¼‰
      /*
      fetch('/api/send-verification-code', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: currentEmail, code: verificationCode })
      })
      .then(res => res.json())
      .then(data => {
        if (!data.success) {
          alert('é©—è­‰ç¢¼é‡æ–°ç™¼é€å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦');
        }
      })
      .catch(err => {
        console.error('é‡æ–°ç™¼é€éŒ¯èª¤ï¼š', err);
        alert('é©—è­‰ç¢¼é‡æ–°ç™¼é€å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦');
      });
      */
      
      // é‡æ–°å•Ÿå‹•å€’è¨ˆæ™‚
      startCountdown();
    }

    // é©—è­‰é©—è­‰ç¢¼
    document.getElementById('verifyCodeBtn').addEventListener('click', () => {
      const code1 = document.getElementById('code1').value;
      const code2 = document.getElementById('code2').value;
      const code3 = document.getElementById('code3').value;
      const code4 = document.getElementById('code4').value;
      const code5 = document.getElementById('code5').value;
      const code6 = document.getElementById('code6').value;
      
      const inputCode = code1 + code2 + code3 + code4 + code5 + code6;
      hideError('codeError');

      // é©—è­‰é©—è­‰ç¢¼
      if (inputCode !== verificationCode) {
        showError('codeError');
        return;
      }

      // é©—è­‰é€šéï¼Œåˆ‡æ›åˆ°æ­¥é©Ÿ3
      showStep('step3');
    });

    // é‡ç½®å¯†ç¢¼
    document.getElementById('resetPasswordBtn').addEventListener('click', () => {
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      hideError('passwordError');
      hideError('confirmError');

      // é©—è­‰å¯†ç¢¼é•·åº¦
      if (newPassword.length < 6) {
        showError('passwordError');
        return;
      }

      // é©—è­‰å…©æ¬¡å¯†ç¢¼æ˜¯å¦ä¸€è‡´
      if (newPassword !== confirmPassword) {
        showError('confirmError');
        return;
      }

      // æ›´æ–°æœ¬åœ°å­˜å„²ä¸­çš„å¯†ç¢¼ï¼ˆæŒ‰ä¿¡ç®±åŒ¹é…ï¼‰
      const tenants = JSON.parse(localStorage.getItem('gdcTenants')) || [];
      const updatedTenants = tenants.map(tenant => {
        if (tenant.email === currentEmail) {
          return { ...tenant, password: newPassword }; // é‡ç½®å¯†ç¢¼
        }
        return tenant;
      });

      // ä¿å­˜æ›´æ–°å¾Œçš„æ•¸æ“š
      localStorage.setItem('gdcTenants', JSON.stringify(updatedTenants));
      
      // åˆ‡æ›åˆ°æˆåŠŸé é¢
      showStep('step4');
    });

    // é©—è­‰ç¢¼è¼¸å…¥æ ¼å¼æ ¡é©—ï¼ˆåƒ…æ•¸å­—ï¼‰
    const codeInputs = ['code1', 'code2', 'code3', 'code4', 'code5', 'code6'];
    codeInputs.forEach(id => {
      document.getElementById(id).addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/\D/g, ''); // ç§»é™¤éæ•¸å­—å­—ç¬¦
      });
    });
  </script>
</body>
</html>