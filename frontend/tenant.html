<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>廣大城租客管理 - 管理員後台</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Microsoft JhengHei', sans-serif;
    }
    
    body {
      background-color: #f5f7fa;
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
      overflow-x: hidden;
    }

    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #eee;
      width: 100%;
    }

    .admin-title {
      color: #1f4e8c;
      font-size: 24px;
      font-weight: bold;
    }

    .logout-btn {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .logout-btn:hover {
      background-color: #c82333;
    }

    .btn-add {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
      margin-bottom: 15px;
    }

    .btn-add:hover {
      background-color: #0056b3;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: white;
      border-radius: 8px;
      padding: 25px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }

    .modal-title {
      font-size: 18px;
      color: #1f4e8c;
      font-weight: bold;
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 20px;
      color: #666;
      cursor: pointer;
    }

    .close-modal:hover {
      color: #dc3545;
    }

    .payment-info-section {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 30px;
      width: 100%;
    }

    .payment-info-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .payment-info-title {
      font-size: 18px;
      color: #1f4e8c;
      font-weight: bold;
    }

    .payment-info-form, .add-album-form, .add-payment-form {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px 20px;
    }

    .form-group {
      margin-bottom: 10px;
    }

    .form-group label {
      display: block;
      font-size: 14px;
      color: #333;
      margin-bottom: 5px;
    }

    .form-input {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .form-input:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }

    .form-input.error {
      border-color: #dc3545;
    }

    .error-message {
      color: #dc3545;
      font-size: 12px;
      margin-top: 3px;
      display: none;
    }

    .btn-save, .btn-submit {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
      grid-column: 1 / -1;
      justify-self: flex-end;
    }

    .btn-save:hover, .btn-submit:hover {
      background-color: #218838;
    }

    .save-success {
      color: #28a745;
      font-size: 14px;
      margin-top: 10px;
      display: none;
      grid-column: 1 / -1;
    }

    .stats-container {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 30px;
      width: 100%;
    }

    .stat-card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
      text-align: center;
    }

    .stat-card h3 {
      color: #666;
      font-size: 14px;
      margin-bottom: 10px;
    }

    .stat-card .value {
      color: #1f4e8c;
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-card .desc {
      color: #999;
      font-size: 12px;
    }

    .admin-tabs {
      display: flex;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      width: 100%;
    }

    .admin-tab {
      padding: 15px 20px;
      font-size: 14px;
      color: #666;
      cursor: pointer;
      border-bottom: 3px solid transparent;
    }

    .admin-tab.active {
      color: #1f4e8c;
      border-bottom-color: #1f4e8c;
      font-weight: bold;
    }

    .admin-tab:hover {
      color: #1f4e8c;
    }

    .table-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 30px;
      width: 100%;
      min-height: 200px;
    }

    .search-input {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      margin-bottom: 20px;
    }

    .empty-text {
      color: #999;
      text-align: center;
      padding: 40px 0;
      font-size: 14px;
    }

    .tenant-table, .album-table, .payment-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .tenant-table th, .tenant-table td,
    .album-table th, .album-table td,
    .payment-table th, .payment-table td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }
    .tenant-table th, .album-table th, .payment-table th {
      background-color: #f8f9fa;
      color: #1f4e8c;
    }
    .tenant-table tr:hover, .album-table tr:hover, .payment-table tr:hover {
      background-color: #f8f9fa;
    }

    .btn-delete {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-left: 5px;
    }
    .btn-delete:hover {
      background-color: #c82333;
    }
    .btn-view {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .btn-view:hover {
      background-color: #0056b3;
    }
    .btn-edit {
      background-color: #ffc107;
      color: #333;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-left: 5px;
    }
    .btn-edit:hover {
      background-color: #e0a800;
    }

    .batch-actions {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      align-items: center;
    }
    .btn-batch-delete {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .btn-batch-delete:hover {
      background-color: #c82333;
    }
    .btn-batch-delete:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }
    .r2-link {
      color: #28a745;
      text-decoration: none;
    }
    .r2-link:hover {
      text-decoration: underline;
    }

    .images-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 20px;
    }
    .image-item {
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }
    .image-item img {
      width: 100%;
      height: 150px;
      object-fit: cover;
      cursor: pointer;
      transition: opacity 0.3s ease;
    }
    .image-item img:hover {
      opacity: 0.9;
    }
    .image-item .download-btn {
      position: absolute;
      bottom: 5px;
      right: 5px;
      background-color: rgba(0, 123, 255, 0.8);
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .image-item .delete-img-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background-color: rgba(220, 53, 69, 0.8);
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }

    /* 圖片預覽彈窗 */
    .image-preview-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }
    .image-preview-content {
      max-width: 90%;
      max-height: 90%;
    }
    .image-preview-close {
      position: absolute;
      top: 20px;
      right: 30px;
      color: white;
      font-size: 40px;
      cursor: pointer;
    }

    /* ===== 圖片上傳模塊樣式 ===== */
    .upload-image-section {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 30px;
      width: 100%;
    }
    .upload-image-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .upload-image-title {
      font-size: 18px;
      color: #1f4e8c;
      font-weight: bold;
    }
    .upload-form {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
    }
    .file-upload-group {
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .file-upload-group:hover {
      border-color: #007bff;
      background-color: #f8f9fa;
    }
    .file-upload-icon {
      font-size: 48px;
      color: #007bff;
      margin-bottom: 15px;
    }
    .file-upload-text {
      font-size: 16px;
      color: #666;
      margin-bottom: 10px;
    }
    .file-upload-tip {
      font-size: 12px;
      color: #999;
    }
    #imageFileInput {
      display: none;
    }
    .upload-room-group {
      display: grid;
      grid-template-columns: 1fr;
      gap: 5px;
    }
    .btn-upload {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
      justify-self: center;
    }
    .btn-upload:hover {
      background-color: #0056b3;
    }
    .btn-upload:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }
    .upload-progress {
      height: 5px;
      background-color: #eee;
      border-radius: 3px;
      overflow: hidden;
      display: none;
    }
    .progress-bar {
      height: 100%;
      background-color: #28a745;
      width: 0%;
      transition: width 0.3s ease;
    }
    .upload-preview {
      margin-top: 20px;
      display: none;
    }
    .preview-title {
      font-size: 14px;
      color: #333;
      margin-bottom: 10px;
    }
    .preview-image {
      max-width: 200px;
      max-height: 200px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <div class="admin-header">
    <h1 class="admin-title">廣大城租客管理 - 管理員後台</h1>
    <button class="logout-btn" id="logoutBtn">
      <i class="fa-solid fa-right-from-bracket"></i> 登出
    </button>
  </div>

  <!-- 租客圖片上傳模塊（頂部） -->
  <div class="upload-image-section">
    <div class="upload-image-header">
      <div class="upload-image-title">租客圖片上傳</div>
    </div>
    <form class="upload-form" id="imageUploadForm">
      <div class="upload-room-group">
        <label for="uploadRoom">房號 *</label>
        <input type="text" id="uploadRoom" class="form-input" placeholder="請輸入房號（如：101）">
        <div class="error-message" id="uploadRoomError">請輸入房號</div>
      </div>
      <div class="file-upload-group" id="fileUploadArea">
        <input type="file" id="imageFileInput" accept="image/jpeg,image/png,image/jpg">
        <div class="file-upload-icon">
          <i class="fa-solid fa-cloud-upload-alt"></i>
        </div>
        <div class="file-upload-text">點擊或拖動圖片到這裡上傳</div>
        <div class="file-upload-tip">支持 JPG、PNG 格式，單張最大 10MB</div>
      </div>
      <div class="upload-progress" id="uploadProgress">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      <button type="button" class="btn-upload" id="uploadImageBtn" disabled>
        <i class="fa-solid fa-upload"></i> 上傳圖片
      </button>
      <div class="upload-preview" id="uploadPreview">
        <div class="preview-title">預覽圖片：</div>
        <img src="" alt="預覽圖片" class="preview-image" id="previewImage">
      </div>
    </form>
  </div>

  <div class="payment-info-section">
    <div class="payment-info-header">
      <div class="payment-info-title">繳租銀行資訊設定</div>
    </div>
    <form class="payment-info-form" id="paymentInfoForm">
      <div class="form-group">
        <label for="bankName">銀行名稱 *</label>
        <input type="text" id="bankName" class="form-input" placeholder="請輸入銀行名稱（如：台新銀行）" value="元大銀行">
        <div class="error-message" id="bankNameError">請輸入銀行名稱</div>
      </div>
      <div class="form-group">
        <label for="branchName">分行名稱 *</label>
        <input type="text" id="branchName" class="form-input" placeholder="請輸入分行名稱（如：台北信義分行）" value="營業部">
        <div class="error-message" id="branchNameError">請輸入分行名稱</div>
      </div>
      <div class="form-group">
        <label for="accountName">戶名 *</label>
        <input type="text" id="accountName" class="form-input" placeholder="請輸入銀行戶名" value="廣大城">
        <div class="error-message" id="accountNameError">請輸入銀行戶名</div>
      </div>
      <div class="form-group">
        <label for="accountNumber">銀行帳號 *</label>
        <input type="text" id="accountNumber" class="form-input" placeholder="請輸入銀行帳號" value="1111-2222-3333">
        <div class="error-message" id="accountNumberError">請輸入銀行帳號</div>
      </div>
      <button type="button" class="btn-save" id="savePaymentInfoBtn">
        <i class="fa-solid fa-save"></i> 儲存資訊
      </button>
      <div class="save-success" id="saveSuccess">✅ 儲存成功！</div>
    </form>
  </div>

  <div class="stats-container">
    <div class="stat-card">
      <h3>總用戶數</h3>
      <div class="value" id="totalTenants">0</div>
      <div class="desc">已註冊租客</div>
    </div>
    <div class="stat-card">
      <h3>總相簿數</h3>
      <div class="value" id="totalAlbums">0</div>
      <div class="desc">所有房間相簿</div>
    </div>
    <div class="stat-card">
      <h3>總繳費記錄</h3>
      <div class="value" id="totalPayments">1</div>
      <div class="desc">總繳費數</div>
    </div>
    <div class="stat-card">
      <h3>總金額</h3>
      <div class="value" id="totalAmountSum">$15500</div>
      <div class="desc">累計收入</div>
    </div>
  </div>

  <div class="admin-tabs">
    <div class="admin-tab" data-tab="tenant">用戶管理</div>
    <div class="admin-tab active" data-tab="album">相簿管理</div>
    <div class="admin-tab" data-tab="payment">繳費記錄管理</div>
  </div>

  <div class="table-container tab-content" id="tenantTabContent">
    <input type="text" class="search-input" placeholder="搜尋用戶姓名、電話或房間號..." id="tenantSearch">
    <div class="batch-actions">
      <input type="checkbox" id="selectAllTenants">
      <label for="selectAllTenants">全選</label>
      <button class="btn-batch-delete" id="batchDeleteTenantBtn" disabled>
        <i class="fa-solid fa-trash"></i> 批量刪除選中租客
      </button>
    </div>
    <div class="empty-text" id="emptyTenantText">暫無用戶資料</div>
    <table class="tenant-table" id="tenantTable" style="display: none;">
      <thead>
        <tr>
          <th><input type="checkbox" id="tableSelectAllTenants"></th>
          <th>姓名</th>
          <th>電話</th>
          <th>信箱</th>
          <th>房號</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="tenantTableBody"></tbody>
    </table>
  </div>

  <div class="table-container tab-content active" id="albumTabContent">
    <button class="btn-add" id="addAlbumBtn">
      <i class="fa-solid fa-plus"></i> 新增相簿
    </button>
    <input type="text" class="search-input" placeholder="搜尋房間號..." id="albumSearch">
    <div class="empty-text" id="emptyAlbumText">暫無相簿資料</div>
    <table class="album-table" id="albumTable" style="display: none;">
      <thead>
        <tr>
          <th><input type="checkbox" id="tableSelectAllAlbums"></th>
          <th>房號</th>
          <th>相簿名稱</th>
          <th>圖片數量</th>
          <th>建立時間</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="albumTableBody"></tbody>
    </table>
  </div>

  <div class="table-container tab-content" id="paymentTabContent">
    <button class="btn-add" id="addPaymentBtn">
      <i class="fa-solid fa-plus"></i> 新增繳費記錄
    </button>
    <input type="text" class="search-input" placeholder="搜尋租客姓名、房號或繳費區間..." id="paymentSearch">
    <div class="batch-actions">
      <input type="checkbox" id="selectAllPayments">
      <label for="selectAllPayments">全選</label>
      <button class="btn-batch-delete" id="batchDeletePaymentBtn" disabled>
        <i class="fa-solid fa-trash"></i> 批量刪除選中記錄
      </button>
    </div>
    <div class="empty-text" id="emptyPaymentText">暫無繳費記錄</div>
    <table class="payment-table" id="paymentTable" style="display: none;">
      <thead>
        <tr>
          <th><input type="checkbox" id="tableSelectAllPayments"></th>
          <th>租客姓名</th>
          <th>房號</th>
          <th>租約期間</th>
          <th>繳費區間</th>
          <th>房租</th>
          <th>電費</th>
          <th>水費</th>
          <th>總金額</th>
          <th>匯款日期</th>
          <th>匯款後五碼</th>
          <th>新增時間</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="paymentTableBody"></tbody>
    </table>
  </div>

  <div class="modal" id="addAlbumModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">新增相簿</h2>
        <button class="close-modal" id="closeAlbumModal">&times;</button>
      </div>
      <form class="add-album-form" id="addAlbumForm">
        <div class="form-group">
          <label for="albumRoom">房號 *</label>
          <input type="text" id="albumRoom" class="form-input" placeholder="請輸入房號（如：101）">
          <div class="error-message" id="albumRoomError">請輸入房號</div>
        </div>
        <div class="form-group">
          <label for="albumName">相簿名稱 *</label>
          <input type="text" id="albumName" class="form-input" placeholder="請輸入相簿名稱">
          <div class="error-message" id="albumNameError">請輸入相簿名稱</div>
        </div>
        <button type="button" class="btn-submit" id="submitAlbumBtn">
          <i class="fa-solid fa-save"></i> 新增相簿
        </button>
        <div class="save-success" id="albumSaveSuccess">✅ 新增成功！</div>
      </form>
    </div>
  </div>

  <div class="modal" id="addPaymentModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">新增繳費記錄</h2>
        <button class="close-modal" id="closePaymentModal">&times;</button>
      </div>
      <form class="add-payment-form" id="addPaymentForm">
        <div class="form-group">
          <label for="paymentTenantName">租客姓名 *</label>
          <input type="text" id="paymentTenantName" class="form-input" placeholder="請輸入租客姓名">
          <div class="error-message" id="paymentTenantNameError">請輸入租客姓名</div>
        </div>
        <div class="form-group">
          <label for="paymentRoom">房號 *</label>
          <input type="text" id="paymentRoom" class="form-input" placeholder="請輸入房號（如：101）">
          <div class="error-message" id="paymentRoomError">請輸入房號</div>
        </div>
        <div class="form-group">
          <label for="paymentRentalPeriod">租約期間</label>
          <input type="text" id="paymentRentalPeriod" class="form-input" placeholder="如：2025/01-2025/12">
        </div>
        <div class="form-group">
          <label for="paymentPeriod">繳費區間 *</label>
          <input type="text" id="paymentPeriod" class="form-input" placeholder="如：2025/01">
          <div class="error-message" id="paymentPeriodError">請輸入繳費區間</div>
        </div>
        <div class="form-group">
          <label for="paymentRent">房租（元） *</label>
          <input type="number" id="paymentRent" class="form-input" placeholder="請輸入房租金額" min="0">
          <div class="error-message" id="paymentRentError">請輸入房租金額</div>
        </div>
        <div class="form-group">
          <label for="paymentElectricity">電費（元）</label>
          <input type="number" id="paymentElectricity" class="form-input" placeholder="請輸入電費金額" min="0" value="0">
        </div>
        <div class="form-group">
          <label for="paymentWater">水費（元）</label>
          <input type="number" id="paymentWater" class="form-input" placeholder="請輸入水費金額" min="0" value="0">
        </div>
        <div class="form-group">
          <label for="paymentDate">匯款日期</label>
          <input type="text" id="paymentDate" class="form-input" placeholder="如：2025/01/15">
        </div>
        <div class="form-group">
          <label for="paymentLast5">匯款後五碼</label>
          <input type="text" id="paymentLast5" class="form-input" placeholder="請輸入匯款帳號後五碼">
        </div>
        <button type="button" class="btn-submit" id="submitPaymentBtn">
          <i class="fa-solid fa-save"></i> 新增繳費記錄
        </button>
        <div class="save-success" id="paymentSaveSuccess">✅ 新增成功！</div>
      </form>
    </div>
  </div>

  <!-- 圖片預覽彈窗 -->
  <div class="image-preview-modal" id="imagePreviewModal">
    <span class="image-preview-close" id="imagePreviewClose">×</span>
    <img class="image-preview-content" id="imagePreviewImg">
  </div>

  <script>
    let currentEditingAlbumIndex = -1;
    let currentEditingPaymentIndex = -1;
    let selectedImageFile = null;

    // 配置：Cloudflare R2 公開訪問地址
    let R2_PUBLIC_URL = "https://pub-8931ead8377a4cd595e51d38fb210975.r2.dev";
    const API_BASE_URL = "http://localhost:3000";

    // 嘗試加載環境配置
    try {
      if (typeof ENV_CONFIG !== 'undefined') {
        R2_PUBLIC_URL = ENV_CONFIG.R2_PUBLIC_URL || R2_PUBLIC_URL;
      }
    } catch (e) {
      console.warn('環境配置文件加載失敗，使用默認 R2 公開地址');
    }

    const adminTabs = document.querySelectorAll('.admin-tab');
    const tabContents = document.querySelectorAll('.tab-content');
    
    adminTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        adminTabs.forEach(t => t.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));
        
        tab.classList.add('active');
        const tabId = tab.getAttribute('data-tab');
        document.getElementById(`${tabId}TabContent`).classList.add('active');
        
        if (tabId === 'album') loadAlbumData();
        if (tabId === 'payment') loadPaymentRecords();
      });
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
      if (confirm('確定要登出嗎？')) {
        window.location.href = 'index.html';
      }
    });

    const bankNameInput = document.getElementById('bankName');
    const branchNameInput = document.getElementById('branchName');
    const accountNameInput = document.getElementById('accountName');
    const accountNumberInput = document.getElementById('accountNumber');
    const savePaymentInfoBtn = document.getElementById('savePaymentInfoBtn');
    const saveSuccess = document.getElementById('saveSuccess');
    
    const bankNameError = document.getElementById('bankNameError');
    const branchNameError = document.getElementById('branchNameError');
    const accountNameError = document.getElementById('accountNameError');
    const accountNumberError = document.getElementById('accountNumberError');

    function validateForm() {
      let isValid = true;
      
      [bankNameInput, branchNameInput, accountNameInput, accountNumberInput].forEach(input => {
        input.classList.remove('error');
      });
      [bankNameError, branchNameError, accountNameError, accountNumberError].forEach(error => {
        error.style.display = 'none';
      });

      if (!bankNameInput.value.trim()) {
        bankNameInput.classList.add('error');
        bankNameError.style.display = 'block';
        isValid = false;
      }

      if (!branchNameInput.value.trim()) {
        branchNameInput.classList.add('error');
        branchNameError.style.display = 'block';
        isValid = false;
      }

      if (!accountNameInput.value.trim()) {
        accountNameInput.classList.add('error');
        accountNameError.style.display = 'block';
        isValid = false;
      }

      if (!accountNumberInput.value.trim()) {
        accountNumberInput.classList.add('error');
        accountNumberError.style.display = 'block';
        isValid = false;
      }

      return isValid;
    }

    savePaymentInfoBtn.addEventListener('click', () => {
      if (!validateForm()) return;

      savePaymentInfoBtn.disabled = true;
      savePaymentInfoBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 處理中...';

      try {
        const paymentInfo = {
          bankName: bankNameInput.value.trim(),
          branchName: branchNameInput.value.trim(),
          accountName: accountNameInput.value.trim(),
          accountNumber: accountNumberInput.value.trim(),
          updateTime: new Date().toLocaleString('zh-TW')
        };

        localStorage.setItem('paymentInfo', JSON.stringify(paymentInfo));
        saveSuccess.style.display = 'block';
        
        setTimeout(() => {
          saveSuccess.style.display = 'none';
          savePaymentInfoBtn.disabled = false;
          savePaymentInfoBtn.innerHTML = '<i class="fa-solid fa-save"></i> 儲存資訊';
        }, 2000);

      } catch (e) {
        console.error('儲存繳租資訊失敗:', e);
        alert('儲存失敗，請稍後再試！');
        savePaymentInfoBtn.disabled = false;
        savePaymentInfoBtn.innerHTML = '<i class="fa-solid fa-save"></i> 儲存資訊';
      }
    });

    [bankNameInput, branchNameInput, accountNameInput, accountNumberInput].forEach(input => {
      input.addEventListener('input', () => {
        input.classList.remove('error');
        document.getElementById(`${input.id}Error`).style.display = 'none';
      });
    });

    window.addEventListener('load', () => {
      try {
        const paymentInfo = JSON.parse(localStorage.getItem('paymentInfo')) || {};
        bankNameInput.value = paymentInfo.bankName || '元大銀行';
        branchNameInput.value = paymentInfo.branchName || '營業部';
        accountNameInput.value = paymentInfo.accountName || '廣大城';
        accountNumberInput.value = paymentInfo.accountNumber || '1111-2222-3333';
      } catch (e) {
        console.error('讀取繳租資訊失敗:', e);
      }

      loadTenantList();
      loadAlbumData();
      loadPaymentRecords();
      loadStatsData();

      bindSearchEvents();
      bindModalEvents();
      bindSelectAllEvents();
      bindAddButtonEvents();
      // 綁定圖片預覽關閉事件
      document.getElementById('imagePreviewClose').addEventListener('click', () => {
        document.getElementById('imagePreviewModal').style.display = 'none';
      });
      // 綁定圖片上傳相關事件
      bindUploadEvents();
    });

    // 圖片上傳相關事件綁定
    function bindUploadEvents() {
      const fileUploadArea = document.getElementById('fileUploadArea');
      const imageFileInput = document.getElementById('imageFileInput');
      const uploadRoomInput = document.getElementById('uploadRoom');
      const uploadImageBtn = document.getElementById('uploadImageBtn');
      const uploadPreview = document.getElementById('uploadPreview');
      const previewImage = document.getElementById('previewImage');
      const uploadRoomError = document.getElementById('uploadRoomError');

      // 點擊上傳區域喚起文件選擇框
      fileUploadArea.addEventListener('click', () => {
        imageFileInput.click();
      });

      // 選擇圖片後的處理
      imageFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) {
          selectedImageFile = null;
          uploadImageBtn.disabled = true;
          uploadPreview.style.display = 'none';
          return;
        }

        // 驗證圖片格式
        const allowedTypes = ['image/jpeg', 'image/png', 'image/jpg'];
        if (!allowedTypes.includes(file.type)) {
          alert('請選擇 JPG 或 PNG 格式的圖片！');
          imageFileInput.value = '';
          selectedImageFile = null;
          uploadImageBtn.disabled = true;
          uploadPreview.style.display = 'none';
          return;
        }

        // 驗證圖片大小（最大 10MB）
        const maxSize = 10 * 1024 * 1024;
        if (file.size > maxSize) {
          alert('圖片大小不能超過 10MB！');
          imageFileInput.value = '';
          selectedImageFile = null;
          uploadImageBtn.disabled = true;
          uploadPreview.style.display = 'none';
          return;
        }

        // 存儲選中的文件
        selectedImageFile = file;

        // 顯示圖片預覽
        const reader = new FileReader();
        reader.onload = (e) => {
          previewImage.src = e.target.result;
          uploadPreview.style.display = 'block';
        };
        reader.readAsDataURL(file);

        // 啟用上傳按鈕（需先填寫房號）
        if (uploadRoomInput.value.trim()) {
          uploadImageBtn.disabled = false;
        }
      });

      // 房號輸入框變更事件
      uploadRoomInput.addEventListener('input', () => {
        uploadRoomError.style.display = 'none';
        uploadRoomInput.classList.remove('error');

        // 啟用/禁用上傳按鈕
        if (uploadRoomInput.value.trim() && selectedImageFile) {
          uploadImageBtn.disabled = false;
        } else {
          uploadImageBtn.disabled = true;
        }
      });

      // 上傳按鈕點擊事件
      uploadImageBtn.addEventListener('click', uploadImageToR2);

      // 拖動文件上傳
      fileUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUploadArea.style.borderColor = '#007bff';
        fileUploadArea.style.backgroundColor = '#f8f9fa';
      });

      fileUploadArea.addEventListener('dragleave', () => {
        fileUploadArea.style.borderColor = '#ddd';
        fileUploadArea.style.backgroundColor = 'transparent';
      });

      fileUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadArea.style.borderColor = '#ddd';
        fileUploadArea.style.backgroundColor = 'transparent';

        const file = e.dataTransfer.files[0];
        if (!file) return;

        // 模擬文件選擇框變更事件
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        imageFileInput.files = dataTransfer.files;
        imageFileInput.dispatchEvent(new Event('change'));
      });
    }

    // 上傳圖片到 Cloudflare R2
    async function uploadImageToR2() {
      const uploadRoomInput = document.getElementById('uploadRoom');
      const uploadImageBtn = document.getElementById('uploadImageBtn');
      const uploadProgress = document.getElementById('uploadProgress');
      const progressBar = document.getElementById('progressBar');
      const uploadRoomError = document.getElementById('uploadRoomError');

      // 隱藏之前的提示信息
      uploadRoomError.style.display = 'none';

      // 驗證房號
      const room = uploadRoomInput.value.trim();
      if (!room) {
        uploadRoomInput.classList.add('error');
        uploadRoomError.style.display = 'block';
        return;
      }

      // 驗證是否選擇了圖片
      if (!selectedImageFile) {
        alert('請先選擇要上傳的圖片！');
        return;
      }

      // 構建 FormData
      const formData = new FormData();
      formData.append('image', selectedImageFile);
      formData.append('room', room);
      formData.append('fileName', selectedImageFile.name);

      // 準備上傳
      uploadImageBtn.disabled = true;
      uploadImageBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 上傳中...';
      uploadProgress.style.display = 'block';
      progressBar.style.width = '0%';

      try {
        // 發送請求到後端接口
        const response = await fetch(`${API_BASE_URL}/api/upload-to-r2`, {
          method: 'POST',
          body: formData,
          onUploadProgress: (e) => {
            if (e.lengthComputable) {
              const progress = (e.loaded / e.total) * 100;
              progressBar.style.width = `${progress}%`;
            }
          }
        });

        // 解析響應結果
        const result = await response.json();

        if (result.success) {
          // 上傳成功
          progressBar.style.width = '100%';
          setTimeout(() => {
            uploadProgress.style.display = 'none';

            // 重置表單
            document.getElementById('imageUploadForm').reset();
            selectedImageFile = null;
            document.getElementById('uploadPreview').style.display = 'none';

            // 同步更新相簿和圖片列表
            loadAlbumData();
            loadStatsData();

            // 還原按鈕狀態
            setTimeout(() => {
              uploadImageBtn.innerHTML = '<i class="fa-solid fa-upload"></i> 上傳圖片';
              uploadImageBtn.disabled = false;
            }, 1000);
          }, 500);
        } else {
          // 上傳失敗
          throw new Error(result.msg || '上傳失敗，後端返回異常');
        }
      } catch (e) {
        console.error('圖片上傳失敗:', e);
        alert(`圖片上傳失敗：${e.message || '請稍後再試！'}`);
        uploadProgress.style.display = 'none';

        // 還原按鈕狀態
        setTimeout(() => {
          uploadImageBtn.disabled = false;
          uploadImageBtn.innerHTML = '<i class="fa-solid fa-upload"></i> 上傳圖片';
        }, 1000);
      }
    }

    function bindSearchEvents() {
      document.getElementById('tenantSearch').addEventListener('input', (e) => {
        const keyword = e.target.value.toLowerCase().trim();
        const rows = document.querySelectorAll('#tenantTableBody tr');
        rows.forEach(row => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(keyword) ? '' : 'none';
        });
      });

      document.getElementById('albumSearch').addEventListener('input', (e) => {
        const keyword = e.target.value.toLowerCase().trim();
        const rows = document.querySelectorAll('#albumTableBody tr');
        rows.forEach(row => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(keyword) ? '' : 'none';
        });
      });

      document.getElementById('paymentSearch').addEventListener('input', (e) => {
        const keyword = e.target.value.toLowerCase().trim();
        const rows = document.querySelectorAll('#paymentTableBody tr');
        rows.forEach(row => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(keyword) ? '' : 'none';
        });
      });
    }

    function bindModalEvents() {
      const addAlbumModal = document.getElementById('addAlbumModal');
      const closeAlbumModal = document.getElementById('closeAlbumModal');
      const addAlbumBtn = document.getElementById('addAlbumBtn');

      addAlbumBtn.addEventListener('click', () => {
        currentEditingAlbumIndex = -1;
        resetAlbumForm();
        addAlbumModal.style.display = 'flex';
      });

      closeAlbumModal.addEventListener('click', () => {
        addAlbumModal.style.display = 'none';
      });

      const addPaymentModal = document.getElementById('addPaymentModal');
      const closePaymentModal = document.getElementById('closePaymentModal');
      const addPaymentBtn = document.getElementById('addPaymentBtn');

      addPaymentBtn.addEventListener('click', () => {
        currentEditingPaymentIndex = -1;
        resetPaymentForm();
        addPaymentModal.style.display = 'flex';
      });

      closePaymentModal.addEventListener('click', () => {
        addPaymentModal.style.display = 'none';
      });

      window.addEventListener('click', (e) => {
        if (e.target === addAlbumModal) addAlbumModal.style.display = 'none';
        if (e.target === addPaymentModal) addPaymentModal.style.display = 'none';
        if (e.target === document.getElementById('imagePreviewModal')) {
          document.getElementById('imagePreviewModal').style.display = 'none';
        }
      });
    }

    function bindAddButtonEvents() {
      document.getElementById('submitAlbumBtn').addEventListener('click', submitAlbum);
      document.getElementById('submitPaymentBtn').addEventListener('click', submitPayment);
    }

    function bindSelectAllEvents() {
      const selectAllTenants = document.getElementById('selectAllTenants');
      const tableSelectAllTenants = document.getElementById('tableSelectAllTenants');
      const batchDeleteTenantBtn = document.getElementById('batchDeleteTenantBtn');

      selectAllTenants.addEventListener('change', (e) => {
        const isChecked = e.target.checked;
        tableSelectAllTenants.checked = isChecked;
        document.querySelectorAll('.tenant-checkbox').forEach(checkbox => {
          checkbox.checked = isChecked;
        });
        batchDeleteTenantBtn.disabled = !isChecked;
      });

      tableSelectAllTenants.addEventListener('change', (e) => {
        const isChecked = e.target.checked;
        selectAllTenants.checked = isChecked;
        document.querySelectorAll('.tenant-checkbox').forEach(checkbox => {
          checkbox.checked = isChecked;
        });
        batchDeleteTenantBtn.disabled = !isChecked;
      });

      const selectAllPayments = document.getElementById('selectAllPayments');
      const tableSelectAllPayments = document.getElementById('tableSelectAllPayments');
      const batchDeletePaymentBtn = document.getElementById('batchDeletePaymentBtn');

      selectAllPayments.addEventListener('change', (e) => {
        const isChecked = e.target.checked;
        tableSelectAllPayments.checked = isChecked;
        document.querySelectorAll('.payment-checkbox').forEach(checkbox => {
          checkbox.checked = isChecked;
        });
        batchDeletePaymentBtn.disabled = !isChecked;
      });

      tableSelectAllPayments.addEventListener('change', (e) => {
        const isChecked = e.target.checked;
        selectAllPayments.checked = isChecked;
        document.querySelectorAll('.payment-checkbox').forEach(checkbox => {
          checkbox.checked = isChecked;
        });
        batchDeletePaymentBtn.disabled = !isChecked;
      });

      const tableSelectAllAlbums = document.getElementById('tableSelectAllAlbums');
      tableSelectAllAlbums.addEventListener('change', (e) => {
        const isChecked = e.target.checked;
        document.querySelectorAll('.album-checkbox').forEach(checkbox => {
          checkbox.checked = isChecked;
        });
      });

      batchDeleteTenantBtn.addEventListener('click', batchDeleteTenants);
      batchDeletePaymentBtn.addEventListener('click', batchDeletePayments);
    }

    function loadTenantList() {
      let tenants = [];
      try {
        const storedTenants = localStorage.getItem('gdcTenants');
        if (storedTenants) {
          tenants = JSON.parse(storedTenants);
          if (!Array.isArray(tenants)) tenants = [];
        }
      } catch (e) {
        console.error('讀取租客列表失敗:', e);
        tenants = [];
      }

      const emptyText = document.getElementById('emptyTenantText');
      const tenantTable = document.getElementById('tenantTable');
      const tenantTableBody = document.getElementById('tenantTableBody');
      const totalTenants = document.getElementById('totalTenants');

      totalTenants.textContent = tenants.length;

      if (tenants.length === 0) {
        emptyText.style.display = 'block';
        tenantTable.style.display = 'none';
        document.getElementById('selectAllTenants').checked = false;
        document.getElementById('tableSelectAllTenants').checked = false;
        document.getElementById('batchDeleteTenantBtn').disabled = true;
        return;
      }

      emptyText.style.display = 'none';
      tenantTable.style.display = 'table';
      tenantTableBody.innerHTML = '';

      tenants.forEach((tenant, index) => {
        const tr = document.createElement('tr');
        tr.setAttribute('data-index', index);
        const name = tenant.name || '未填寫';
        const phone = tenant.phone || '未填寫';
        const email = tenant.email || '未填寫';
        const room = tenant.room || '未填寫';

        tr.innerHTML = `
          <td><input type="checkbox" class="tenant-checkbox" data-index="${index}"></td>
          <td>${name}</td>
          <td>${phone}</td>
          <td>${email}</td>
          <td>${room}</td>
          <td>
            <button class="btn-view" onclick="viewTenantImages('${room}')">查看圖片</button>
            <button class="btn-delete" onclick="deleteTenant(${index})">刪除</button>
          </td>
        `;
        tenantTableBody.appendChild(tr);
      });

      document.querySelectorAll('.tenant-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateTenantBatchDeleteBtnStatus);
      });

      updateTenantBatchDeleteBtnStatus();
    }

    function deleteTenant(index) {
      if (!confirm('確定要刪除該租客資訊嗎？刪除後無法復原！')) return;

      try {
        let tenants = JSON.parse(localStorage.getItem('gdcTenants')) || [];
        tenants.splice(index, 1);
        localStorage.setItem('gdcTenants', JSON.stringify(tenants));
        
        deleteTenantRelatedData(tenants, index);
        
        loadTenantList();
        loadAlbumData();
        loadPaymentRecords();
        loadStatsData();
        
        alert('租客資訊刪除成功！');
      } catch (e) {
        console.error('刪除租客失敗:', e);
        alert('刪除租客資訊失敗，請稍後再試！');
      }
    }

    function batchDeleteTenants() {
      const checkedCheckboxes = document.querySelectorAll('.tenant-checkbox:checked');
      if (checkedCheckboxes.length === 0) {
        alert('請先選擇要刪除的租客！');
        return;
      }

      if (!confirm(`確定要刪除選中的${checkedCheckboxes.length}位租客資訊嗎？刪除後無法復原！`)) return;

      try {
        let tenants = JSON.parse(localStorage.getItem('gdcTenants')) || [];
        const selectedIndexes = Array.from(checkedCheckboxes)
          .map(checkbox => parseInt(checkbox.getAttribute('data-index')))
          .sort((a, b) => b - a);
        
        selectedIndexes.forEach(index => {
          tenants.splice(index, 1);
        });
        
        localStorage.setItem('gdcTenants', JSON.stringify(tenants));
        
        selectedIndexes.forEach(index => {
          deleteTenantRelatedData(tenants, index);
        });
        
        loadTenantList();
        loadAlbumData();
        loadPaymentRecords();
        loadStatsData();
        
        alert(`成功刪除${selectedIndexes.length}位租客資訊！`);
      } catch (e) {
        console.error('批量刪除租客失敗:', e);
        alert('批量刪除租客資訊失敗，請稍後再試！');
      }
    }

    function deleteTenantRelatedData(tenants, index) {
      try {
        const tenant = tenants[index];
        if (!tenant || !tenant.room) return;
        const room = tenant.room;
        
        let albums = JSON.parse(localStorage.getItem('roomAlbums')) || [];
        albums = albums.filter(album => album.room !== room);
        localStorage.setItem('roomAlbums', JSON.stringify(albums));
        
        let roomImages = JSON.parse(localStorage.getItem('roomImages')) || {};
        if (roomImages[room]) {
          delete roomImages[room];
          localStorage.setItem('roomImages', JSON.stringify(roomImages));
        }
        
        let paymentRecords = JSON.parse(localStorage.getItem('paymentRecords')) || [];
        paymentRecords = paymentRecords.filter(record => record.room !== room);
        localStorage.setItem('paymentRecords', JSON.stringify(paymentRecords));
      } catch (e) {
        console.error('刪除租客相關數據失敗:', e);
      }
    }

    function updateTenantBatchDeleteBtnStatus() {
      const checkboxes = document.querySelectorAll('.tenant-checkbox:checked');
      const batchDeleteBtn = document.getElementById('batchDeleteTenantBtn');
      batchDeleteBtn.disabled = checkboxes.length === 0;
      
      const allCheckboxes = document.querySelectorAll('.tenant-checkbox');
      const selectAllTenants = document.getElementById('selectAllTenants');
      const tableSelectAllTenants = document.getElementById('tableSelectAllTenants');
      
      if (allCheckboxes.length === 0) {
        selectAllTenants.checked = false;
        tableSelectAllTenants.checked = false;
      } else if (checkboxes.length === allCheckboxes.length) {
        selectAllTenants.checked = true;
        tableSelectAllTenants.checked = true;
      } else {
        selectAllTenants.checked = false;
        tableSelectAllTenants.checked = false;
      }
    }

    function loadAlbumData() {
      let albums = [];
      try {
        albums = JSON.parse(localStorage.getItem('roomAlbums')) || [];
        if (!Array.isArray(albums)) albums = [];
      } catch (e) {
        console.error('讀取相簿列表失敗:', e);
        albums = [];
      }

      const emptyText = document.getElementById('emptyAlbumText');
      const albumTable = document.getElementById('albumTable');
      const albumTableBody = document.getElementById('albumTableBody');
      const totalAlbums = document.getElementById('totalAlbums');

      totalAlbums.textContent = albums.length;

      if (albums.length === 0) {
        emptyText.style.display = 'block';
        albumTable.style.display = 'none';
        document.getElementById('tableSelectAllAlbums').checked = false;
        return;
      }

      emptyText.style.display = 'none';
      albumTable.style.display = 'table';
      albumTableBody.innerHTML = '';

      albums.forEach((album, index) => {
        const tr = document.createElement('tr');
        tr.setAttribute('data-index', index);
        const room = album.room || '未填寫';
        const name = album.name || '未命名相簿';
        const imageCount = album.images ? album.images.length : 0;
        const createTime = album.createTime || '未知時間';

        tr.innerHTML = `
          <td><input type="checkbox" class="album-checkbox" data-index="${index}"></td>
          <td>${room}</td>
          <td>${name}</td>
          <td>${imageCount}</td>
          <td>${createTime}</td>
          <td>
            <button class="btn-view" onclick="viewAlbumImages(${index})">查看圖片</button>
            <button class="btn-delete" onclick="deleteAlbum(${index})">刪除</button>
          </td>
        `;
        albumTableBody.appendChild(tr);
      });
    }

    // 刪除相簿
    function deleteAlbum(index) {
      if (!confirm('確定要刪除該相簿嗎？刪除後無法復原！')) return;

      try {
        let albums = JSON.parse(localStorage.getItem('roomAlbums')) || [];
        // 刪除相簿對應的圖片記錄
        const albumRoom = albums[index].room;
        let roomImages = JSON.parse(localStorage.getItem('roomImages')) || {};
        if (roomImages[albumRoom]) delete roomImages[albumRoom];
        localStorage.setItem('roomImages', JSON.stringify(roomImages));
        
        // 刪除相簿
        albums.splice(index, 1);
        localStorage.setItem('roomAlbums', JSON.stringify(albums));
        
        loadAlbumData();
        loadStatsData();
        alert('相簿刪除成功！');
      } catch (e) {
        console.error('刪除相簿失敗:', e);
        alert('刪除相簿失敗，請稍後再試！');
      }
    }

    // 重置相簿表單
    function resetAlbumForm() {
      document.getElementById('addAlbumForm').reset();
      document.getElementById('albumRoomError').style.display = 'none';
      document.getElementById('albumNameError').style.display = 'none';
      document.getElementById('albumRoom').classList.remove('error');
      document.getElementById('albumName').classList.remove('error');
      document.getElementById('albumSaveSuccess').style.display = 'none';
      document.querySelector('#addAlbumModal .modal-title').textContent = '新增相簿';
      document.getElementById('submitAlbumBtn').innerHTML = '<i class="fa-solid fa-save"></i> 新增相簿';
    }

    // 提交相簿（新增）
    function submitAlbum() {
      const albumRoom = document.getElementById('albumRoom').value.trim();
      const albumName = document.getElementById('albumName').value.trim();
      
      // 表單驗證
      let isValid = true;
      document.getElementById('albumRoomError').style.display = 'none';
      document.getElementById('albumNameError').style.display = 'none';
      document.getElementById('albumRoom').classList.remove('error');
      document.getElementById('albumName').classList.remove('error');
      
      if (!albumRoom) {
        document.getElementById('albumRoom').classList.add('error');
        document.getElementById('albumRoomError').style.display = 'block';
        isValid = false;
      }
      
      if (!albumName) {
        document.getElementById('albumName').classList.add('error');
        document.getElementById('albumNameError').style.display = 'block';
        isValid = false;
      }
      
      if (!isValid) return;
      
      // 構建相簿數據
      const albumData = {
        room: albumRoom,
        name: albumName,
        images: [],
        createTime: new Date().toLocaleString('zh-TW'),
        updateTime: new Date().toLocaleString('zh-TW')
      };
      
      try {
        let albums = JSON.parse(localStorage.getItem('roomAlbums')) || [];
        albums.push(albumData);
        localStorage.setItem('roomAlbums', JSON.stringify(albums));
        
        // 提示成功並關閉彈窗
        document.getElementById('albumSaveSuccess').style.display = 'block';
        setTimeout(() => {
          document.getElementById('addAlbumModal').style.display = 'none';
          loadAlbumData();
          loadStatsData();
        }, 1500);
      } catch (e) {
        console.error('保存相簿失敗:', e);
        alert('保存相簿失敗，請稍後再試！');
      }
    }

    // 刪除相簿中的單張圖片
    function deleteAlbumImage(albumIndex, imgIndex) {
      if (!confirm('確定要刪除這張圖片嗎？')) return;
      try {
        let albums = JSON.parse(localStorage.getItem('roomAlbums')) || [];
        const album = albums[albumIndex];
        // 刪除圖片數組中的對應項
        album.images.splice(imgIndex, 1);
        localStorage.setItem('roomAlbums', JSON.stringify(albums));
        
        // 同步更新roomImages
        let roomImages = JSON.parse(localStorage.getItem('roomImages')) || {};
        const room = album.room;
        if (roomImages[room]) {
          roomImages[room] = roomImages[room].filter(img => !album.images.includes(img));
          localStorage.setItem('roomImages', JSON.stringify(roomImages));
        }
        
        // 重新加載相簿圖片
        viewAlbumImages(albumIndex);
        loadAlbumData();
      } catch (e) {
        console.error('刪除圖片失敗:', e);
        alert('刪除圖片失敗，請稍後再試！');
      }
    }

    // 查看相簿圖片
    function viewAlbumImages(index) {
      try {
        const albums = JSON.parse(localStorage.getItem('roomAlbums')) || [];
        if (index < 0 || index >= albums.length) return;
        
        const album = albums[index];
        const images = album.images || [];
        
        // 創建臨時圖片網格容器
        let imagesModal = document.getElementById('tempImagesModal');
        if (!imagesModal) {
          imagesModal = document.createElement('div');
          imagesModal.id = 'tempImagesModal';
          imagesModal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            padding: 40px 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
          `;
          
          const closeBtn = document.createElement('button');
          closeBtn.style.cssText = `
            align-self: flex-end;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            cursor: pointer;
            margin-bottom: 20px;
          `;
          closeBtn.innerHTML = '<i class="fa-solid fa-xmark"></i> 關閉';
          closeBtn.addEventListener('click', () => {
            imagesModal.remove();
          });
          
          const title = document.createElement('h2');
          title.style.cssText = `
            color: white;
            margin-bottom: 30px;
            font-size: 18px;
          `;
          title.textContent = `相簿：${album.room} - ${album.name}`;
          
          imagesModal.appendChild(closeBtn);
          imagesModal.appendChild(title);
          document.body.appendChild(imagesModal);
        } else {
          // 清空原有內容
          const grid = imagesModal.querySelector('.images-grid');
          if (grid) grid.remove();
        }
        
        // 創建圖片網格
        const imagesGrid = document.createElement('div');
        imagesGrid.className = 'images-grid';
        imagesGrid.style.gap = '15px';
        imagesGrid.style.width = '90%';
        imagesGrid.style.maxWidth = '1200px';
        
        if (images.length === 0) {
          const emptyTip = document.createElement('div');
          emptyTip.style.cssText = 'color: #999; text-align: center; padding: 50px 0; width: 100%;';
          emptyTip.textContent = '此相簿暫無圖片';
          imagesGrid.appendChild(emptyTip);
        } else {
          images.forEach((imgUrl, imgIndex) => {
            const imageItem = document.createElement('div');
            imageItem.className = 'image-item';
            imageItem.style.position = 'relative';
            
            const img = document.createElement('img');
            img.src = imgUrl;
            img.alt = `相簿圖片 ${imgUrl.split('/').pop()}`;
            img.style.width = '100%';
            img.style.height = '180px';
            img.style.objectFit = 'cover';
            img.style.borderRadius = '4px';
            img.style.cursor = 'pointer';
            img.style.transition = 'opacity 0.3s ease';
            
            // 圖片預覽事件
            img.addEventListener('click', () => {
              const previewModal = document.getElementById('imagePreviewModal');
              const previewImg = document.getElementById('imagePreviewImg');
              previewImg.src = imgUrl;
              previewModal.style.display = 'flex';
            });
            
            // 下載按鈕
            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'download-btn';
            downloadBtn.innerHTML = '<i class="fa-solid fa-download"></i>';
            downloadBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              const a = document.createElement('a');
              a.href = imgUrl;
              a.download = `相簿圖片_${imgUrl.split('/').pop()}`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
            });
            
            // 刪除按鈕
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-img-btn';
            deleteBtn.innerHTML = '<i class="fa-solid fa-times"></i>';
            deleteBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              deleteAlbumImage(index, imgIndex);
            });
            
            imageItem.appendChild(img);
            imageItem.appendChild(downloadBtn);
            imageItem.appendChild(deleteBtn);
            imagesGrid.appendChild(imageItem);
          });
        }
        
        imagesModal.appendChild(imagesGrid);
      } catch (e) {
        console.error('查看相簿圖片失敗:', e);
        alert('加載相簿圖片失敗，請稍後再試！');
      }
    }

    // 查看租客對應房號的圖片
    function viewTenantImages(room) {
      try {
        let albums = JSON.parse(localStorage.getItem('roomAlbums')) || [];
        // 查找該房號對應的所有相簿
        const roomAlbums = albums.filter(album => album.room === room);
        
        if (roomAlbums.length === 0) {
          alert(`房號 ${room} 暫無相簿和圖片`);
          return;
        }
        
        // 合併所有相簿的圖片
        let allImages = [];
        roomAlbums.forEach(album => {
          allImages = allImages.concat(album.images || []);
        });
        
        if (allImages.length === 0) {
          alert(`房號 ${room} 的相簿暫無圖片`);
          return;
        }
        
        // 創建臨時圖片容器
        let imagesModal = document.getElementById('tempTenantImagesModal');
        if (!imagesModal) {
          imagesModal = document.createElement('div');
          imagesModal.id = 'tempTenantImagesModal';
          imagesModal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            padding: 40px 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
          `;
          
          const closeBtn = document.createElement('button');
          closeBtn.style.cssText = `
            align-self: flex-end;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            cursor: pointer;
            margin-bottom: 20px;
          `;
          closeBtn.innerHTML = '<i class="fa-solid fa-xmark"></i> 關閉';
          closeBtn.addEventListener('click', () => {
            imagesModal.remove();
          });
          
          const title = document.createElement('h2');
          title.style.cssText = `
            color: white;
            margin-bottom: 30px;
            font-size: 18px;
          `;
          title.textContent = `房號 ${room} - 所有圖片`;
          
          imagesModal.appendChild(closeBtn);
          imagesModal.appendChild(title);
          document.body.appendChild(imagesModal);
        } else {
          const grid = imagesModal.querySelector('.images-grid');
          if (grid) grid.remove();
        }
        
        // 創建圖片網格
        const imagesGrid = document.createElement('div');
        imagesGrid.className = 'images-grid';
        imagesGrid.style.gap = '15px';
        imagesGrid.style.width = '90%';
        imagesGrid.style.maxWidth = '1200px';
        
        allImages.forEach(imgUrl => {
          const imageItem = document.createElement('div');
          imageItem.className = 'image-item';
          imageItem.style.position = 'relative';
          
          const img = document.createElement('img');
          img.src = imgUrl;
          img.alt = `租客圖片 ${imgUrl.split('/').pop()}`;
          img.style.width = '100%';
          img.style.height = '180px';
          img.style.objectFit = 'cover';
          img.style.borderRadius = '4px';
          img.style.cursor = 'pointer';
          img.style.transition = 'opacity 0.3s ease';
          
          // 圖片預覽
          img.addEventListener('click', () => {
            const previewModal = document.getElementById('imagePreviewModal');
            const previewImg = document.getElementById('imagePreviewImg');
            previewImg.src = imgUrl;
            previewModal.style.display = 'flex';
          });
          
          // 下載按鈕
          const downloadBtn = document.createElement('button');
          downloadBtn.className = 'download-btn';
          downloadBtn.innerHTML = '<i class="fa-solid fa-download"></i>';
          downloadBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const a = document.createElement('a');
            a.href = imgUrl;
            a.download = `房號${room}_圖片_${imgUrl.split('/').pop()}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
          });
          
          imageItem.appendChild(img);
          imageItem.appendChild(downloadBtn);
          imagesGrid.appendChild(imageItem);
        });
        
        imagesModal.appendChild(imagesGrid);
      } catch (e) {
        console.error('查看租客圖片失敗:', e);
        alert('加載租客圖片失敗，請稍後再試！');
      }
    }

    // 加載繳費記錄
    function loadPaymentRecords() {
      let payments = [];
      try {
        payments = JSON.parse(localStorage.getItem('paymentRecords')) || [];
        if (!Array.isArray(payments)) payments = [];
      } catch (e) {
        console.error('讀取繳費記錄失敗:', e);
        payments = [];
      }

      const emptyText = document.getElementById('emptyPaymentText');
      const paymentTable = document.getElementById('paymentTable');
      const paymentTableBody = document.getElementById('paymentTableBody');
      const totalPayments = document.getElementById('totalPayments');
      const totalAmountSum = document.getElementById('totalAmountSum');

      totalPayments.textContent = payments.length;

      // 計算總金額
      let totalAmount = 0;
      payments.forEach(payment => {
        const rent = parseInt(payment.rent) || 0;
        const electricity = parseInt(payment.electricity) || 0;
        const water = parseInt(payment.water) || 0;
        totalAmount += rent + electricity + water;
      });
      totalAmountSum.textContent = `$${totalAmount.toLocaleString()}`;

      if (payments.length === 0) {
        emptyText.style.display = 'block';
        paymentTable.style.display = 'none';
        document.getElementById('selectAllPayments').checked = false;
        document.getElementById('tableSelectAllPayments').checked = false;
        document.getElementById('batchDeletePaymentBtn').disabled = true;
        return;
      }

      emptyText.style.display = 'none';
      paymentTable.style.display = 'table';
      paymentTableBody.innerHTML = '';

      payments.forEach((payment, index) => {
        const tr = document.createElement('tr');
        tr.setAttribute('data-index', index);
        const name = payment.tenantName || '未填寫';
        const room = payment.room || '未填寫';
        const rentalPeriod = payment.rentalPeriod || '未填寫';
        const paymentPeriod = payment.paymentPeriod || '未填寫';
        const rent = payment.rent || '0';
        const electricity = payment.electricity || '0';
        const water = payment.water || '0';
        const total = (parseInt(rent) + parseInt(electricity) + parseInt(water)).toLocaleString();
        const paymentDate = payment.paymentDate || '未填寫';
        const last5 = payment.last5 || '未填寫';
        const createTime = payment.createTime || '未知時間';

        tr.innerHTML = `
          <td><input type="checkbox" class="payment-checkbox" data-index="${index}"></td>
          <td>${name}</td>
          <td>${room}</td>
          <td>${rentalPeriod}</td>
          <td>${paymentPeriod}</td>
          <td>$${rent}</td>
          <td>$${electricity}</td>
          <td>$${water}</td>
          <td>$${total}</td>
          <td>${paymentDate}</td>
          <td>${last5}</td>
          <td>${createTime}</td>
          <td>
            <button class="btn-delete" onclick="deletePayment(${index})">刪除</button>
          </td>
        `;
        paymentTableBody.appendChild(tr);
      });

      document.querySelectorAll('.payment-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updatePaymentBatchDeleteBtnStatus);
      });

      updatePaymentBatchDeleteBtnStatus();
    }

    // 刪除繳費記錄
    function deletePayment(index) {
      if (!confirm('確定要刪除該繳費記錄嗎？刪除後無法復原！')) return;

      try {
        let payments = JSON.parse(localStorage.getItem('paymentRecords')) || [];
        payments.splice(index, 1);
        localStorage.setItem('paymentRecords', JSON.stringify(payments));
        
        loadPaymentRecords();
        loadStatsData();
        alert('繳費記錄刪除成功！');
      } catch (e) {
        console.error('刪除繳費記錄失敗:', e);
        alert('刪除繳費記錄失敗，請稍後再試！');
      }
    }

    // 批量刪除繳費記錄
    function batchDeletePayments() {
      const checkedCheckboxes = document.querySelectorAll('.payment-checkbox:checked');
      if (checkedCheckboxes.length === 0) {
        alert('請先選擇要刪除的繳費記錄！');
        return;
      }

      if (!confirm(`確定要刪除選中的${checkedCheckboxes.length}條繳費記錄嗎？刪除後無法復原！`)) return;

      try {
        let payments = JSON.parse(localStorage.getItem('paymentRecords')) || [];
        const selectedIndexes = Array.from(checkedCheckboxes)
          .map(checkbox => parseInt(checkbox.getAttribute('data-index')))
          .sort((a, b) => b - a);
        
        selectedIndexes.forEach(index => {
          payments.splice(index, 1);
        });
        
        localStorage.setItem('paymentRecords', JSON.stringify(payments));
        
        loadPaymentRecords();
        loadStatsData();
        
        alert(`成功刪除${selectedIndexes.length}條繳費記錄！`);
      } catch (e) {
        console.error('批量刪除繳費記錄失敗:', e);
        alert('批量刪除繳費記錄失敗，請稍後再試！');
      }
    }

    // 更新繳費記錄批量刪除按鈕狀態
    function updatePaymentBatchDeleteBtnStatus() {
      const checkboxes = document.querySelectorAll('.payment-checkbox:checked');
      const batchDeleteBtn = document.getElementById('batchDeletePaymentBtn');
      batchDeleteBtn.disabled = checkboxes.length === 0;
      
      const allCheckboxes = document.querySelectorAll('.payment-checkbox');
      const selectAllPayments = document.getElementById('selectAllPayments');
      const tableSelectAllPayments = document.getElementById('tableSelectAllPayments');
      
      if (allCheckboxes.length === 0) {
        selectAllPayments.checked = false;
        tableSelectAllPayments.checked = false;
      } else if (checkboxes.length === allCheckboxes.length) {
        selectAllPayments.checked = true;
        tableSelectAllPayments.checked = true;
      } else {
        selectAllPayments.checked = false;
        tableSelectAllPayments.checked = false;
      }
    }

    // 重置繳費記錄表單
    function resetPaymentForm() {
      document.getElementById('addPaymentForm').reset();
      const errorElements = document.querySelectorAll('#addPaymentForm .error-message');
      errorElements.forEach(error => {
        error.style.display = 'none';
      });
      const inputElements = document.querySelectorAll('#addPaymentForm .form-input');
      inputElements.forEach(input => {
        input.classList.remove('error');
      });
      document.getElementById('paymentSaveSuccess').style.display = 'none';
      document.querySelector('#addPaymentModal .modal-title').textContent = '新增繳費記錄';
      document.getElementById('submitPaymentBtn').innerHTML = '<i class="fa-solid fa-save"></i> 新增繳費記錄';
    }

    // 提交繳費記錄（新增）
    function submitPayment() {
      const tenantName = document.getElementById('paymentTenantName').value.trim();
      const room = document.getElementById('paymentRoom').value.trim();
      const rentalPeriod = document.getElementById('paymentRentalPeriod').value.trim();
      const paymentPeriod = document.getElementById('paymentPeriod').value.trim();
      const rent = document.getElementById('paymentRent').value.trim();
      const electricity = document.getElementById('paymentElectricity').value.trim() || '0';
      const water = document.getElementById('paymentWater').value.trim() || '0';
      const paymentDate = document.getElementById('paymentDate').value.trim();
      const last5 = document.getElementById('paymentLast5').value.trim();
      
      // 表單驗證
      let isValid = true;
      document.getElementById('paymentTenantNameError').style.display = 'none';
      document.getElementById('paymentRoomError').style.display = 'none';
      document.getElementById('paymentPeriodError').style.display = 'none';
      document.getElementById('paymentRentError').style.display = 'none';
      document.getElementById('paymentTenantName').classList.remove('error');
      document.getElementById('paymentRoom').classList.remove('error');
      document.getElementById('paymentPeriod').classList.remove('error');
      document.getElementById('paymentRent').classList.remove('error');
      
      if (!tenantName) {
        document.getElementById('paymentTenantName').classList.add('error');
        document.getElementById('paymentTenantNameError').style.display = 'block';
        isValid = false;
      }
      
      if (!room) {
        document.getElementById('paymentRoom').classList.add('error');
        document.getElementById('paymentRoomError').style.display = 'block';
        isValid = false;
      }
      
      if (!paymentPeriod) {
        document.getElementById('paymentPeriod').classList.add('error');
        document.getElementById('paymentPeriodError').style.display = 'block';
        isValid = false;
      }
      
      if (!rent || isNaN(parseInt(rent)) || parseInt(rent) < 0) {
        document.getElementById('paymentRent').classList.add('error');
        document.getElementById('paymentRentError').style.display = 'block';
        isValid = false;
      }
      
      if (!isValid) return;
      
      // 構建繳費記錄數據
      const paymentData = {
        tenantName,
        room,
        rentalPeriod,
        paymentPeriod,
        rent,
        electricity,
        water,
        paymentDate,
        last5,
        createTime: new Date().toLocaleString('zh-TW'),
        updateTime: new Date().toLocaleString('zh-TW')
      };
      
      try {
        let payments = JSON.parse(localStorage.getItem('paymentRecords')) || [];
        payments.push(paymentData);
        localStorage.setItem('paymentRecords', JSON.stringify(payments));
        
        // 提示成功並關閉彈窗
        document.getElementById('paymentSaveSuccess').style.display = 'block';
        setTimeout(() => {
          document.getElementById('addPaymentModal').style.display = 'none';
          loadPaymentRecords();
          loadStatsData();
        }, 1500);
      } catch (e) {
        console.error('保存繳費記錄失敗:', e);
        alert('保存繳費記錄失敗，請稍後再試！');
      }
    }

    // 加載統計數據
    function loadStatsData() {
      try {
        const tenants = JSON.parse(localStorage.getItem('gdcTenants')) || [];
        const albums = JSON.parse(localStorage.getItem('roomAlbums')) || [];
        const payments = JSON.parse(localStorage.getItem('paymentRecords')) || [];
        
        // 更新統計數字
        document.getElementById('totalTenants').textContent = tenants.length;
        document.getElementById('totalAlbums').textContent = albums.length;
        document.getElementById('totalPayments').textContent = payments.length;
        
        // 計算總金額
        let totalAmount = 0;
        payments.forEach(payment => {
          const rent = parseInt(payment.rent) || 0;
          const electricity = parseInt(payment.electricity) || 0;
          const water = parseInt(payment.water) || 0;
          totalAmount += rent + electricity + water;
        });
        document.getElementById('totalAmountSum').textContent = `$${totalAmount.toLocaleString()}`;
      } catch (e) {
        console.error('加載統計數據失敗:', e);
      }
    }
  </script>
</body>
</html>