<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>廣大城租客管理 - 管理員後台</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* 基礎樣式重置 */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Microsoft JhengHei', sans-serif;
    }
    
    body {
      background-color: #f5f7fa;
      padding: 20px;
    }

    /* 頁頭樣式 */
    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #eee;
    }

    .admin-title {
      color: #1f4e8c;
      font-size: 24px;
      font-weight: bold;
    }

    .logout-btn {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .logout-btn:hover {
      background-color: #c82333;
    }

    /* 新增按鈕通用樣式 */
    .btn-add {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
      margin-bottom: 15px;
    }

    .btn-add:hover {
      background-color: #0056b3;
    }

    /* 彈窗樣式 */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: white;
      border-radius: 8px;
      padding: 25px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }

    .modal-title {
      font-size: 18px;
      color: #1f4e8c;
      font-weight: bold;
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 20px;
      color: #666;
      cursor: pointer;
    }

    .close-modal:hover {
      color: #dc3545;
    }

    /* 新增繳租資訊樣式 */
    .payment-info-section {
      max-width: 1200px;
      margin: 0 auto 30px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
    }

    .payment-info-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .payment-info-title {
      font-size: 18px;
      color: #1f4e8c;
      font-weight: bold;
    }

    .payment-info-form, .add-album-form, .add-payment-form {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px 20px;
    }

    .form-group {
      margin-bottom: 10px;
    }

    .form-group label {
      display: block;
      font-size: 14px;
      color: #333;
      margin-bottom: 5px;
    }

    .form-input {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .form-input:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }

    /* 表單驗證錯誤樣式 */
    .form-input.error {
      border-color: #dc3545;
    }

    .error-message {
      color: #dc3545;
      font-size: 12px;
      margin-top: 3px;
      display: none;
    }

    .btn-save, .btn-submit {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
      grid-column: 1 / -1;
      justify-self: flex-end;
      transition: background-color 0.3s;
    }

    .btn-save:hover, .btn-submit:hover {
      background-color: #218838;
    }

    .btn-save:disabled, .btn-submit:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }

    .save-success {
      color: #28a745;
      font-size: 14px;
      margin-top: 10px;
      display: none;
      grid-column: 1 / -1;
    }

    /* 統計卡片樣式 */
    .stats-container {
      max-width: 1200px;
      margin: 0 auto 30px;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
    }

    .stat-card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
      text-align: center;
    }

    .stat-card h3 {
      color: #666;
      font-size: 14px;
      margin-bottom: 10px;
    }

    .stat-card .value {
      color: #1f4e8c;
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-card .desc {
      color: #999;
      font-size: 12px;
    }

    /* 後台標籤樣式 */
    .admin-tabs {
      max-width: 1200px;
      margin: 0 auto 20px;
      display: flex;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .admin-tab {
      padding: 15px 20px;
      font-size: 14px;
      color: #666;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }

    .admin-tab.active {
      color: #1f4e8c;
      border-bottom-color: #1f4e8c;
      font-weight: bold;
    }

    .admin-tab:hover {
      color: #1f4e8c;
    }

    /* 表格容器樣式 */
    .table-container {
      max-width: 1200px;
      margin: 0 auto 30px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
    }

    .search-input {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      margin-bottom: 20px;
    }

    .empty-text {
      color: #999;
      text-align: center;
      padding: 40px 0;
      font-size: 14px;
    }

    /* 租客列表表格樣式 */
    .tenant-table, .album-table, .payment-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .tenant-table th, .tenant-table td,
    .album-table th, .album-table td,
    .payment-table th, .payment-table td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }
    .tenant-table th, .album-table th, .payment-table th {
      background-color: #f8f9fa;
      color: #1f4e8c;
    }
    .tenant-table tr:hover, .album-table tr:hover, .payment-table tr:hover {
      background-color: #f8f9fa;
    }

    /* 按鈕樣式 */
    .btn-delete {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-left: 5px;
    }
    .btn-delete:hover {
      background-color: #c82333;
    }
    .btn-view {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .btn-view:hover {
      background-color: #0056b3;
    }
    .btn-edit {
      background-color: #ffc107;
      color: #333;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-left: 5px;
    }
    .btn-edit:hover {
      background-color: #e0a800;
    }

    /* 批量操作按鈕樣式 */
    .batch-actions {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      align-items: center;
    }
    .btn-batch-delete {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .btn-batch-delete:hover {
      background-color: #c82333;
    }
    .btn-batch-delete:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }
    .mega-link {
      color: #007bff;
      text-decoration: none;
    }

    /* 圖片展示樣式 */
    .images-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 20px;
    }
    .image-item {
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: hidden;
    }
    .image-item img {
      width: 100%;
      height: 150px;
      object-fit: cover;
    }

    /* 標籤內容容器 */
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="admin-header">
    <h1 class="admin-title">廣大城租客管理 - 管理員後台</h1>
    <button class="logout-btn" id="logoutBtn">
      <<i class="fa-solid fa-right-from-bracket"></</i> 登出
    </button>
  </div>

  <!-- 繳租銀行資訊設定區塊 -->
  <div class="payment-info-section">
    <div class="payment-info-header">
      <div class="payment-info-title">繳租銀行資訊設定</div>
    </div>
    <form class="payment-info-form" id="paymentInfoForm">
      <div class="form-group">
        <label for="bankName">銀行名稱 *</label>
        <input type="text" id="bankName" class="form-input" placeholder="請輸入銀行名稱（如：台新銀行）">
        <div class="error-message" id="bankNameError">請輸入銀行名稱</div>
      </div>
      <div class="form-group">
        <label for="branchName">分行名稱 *</label>
        <input type="text" id="branchName" class="form-input" placeholder="請輸入分行名稱（如：台北信義分行）">
        <div class="error-message" id="branchNameError">請輸入分行名稱</div>
      </div>
      <div class="form-group">
        <label for="accountName">戶名 *</label>
        <input type="text" id="accountName" class="form-input" placeholder="請輸入銀行戶名">
        <div class="error-message" id="accountNameError">請輸入銀行戶名</div>
      </div>
      <div class="form-group">
        <label for="accountNumber">銀行帳號 *</label>
        <input type="text" id="accountNumber" class="form-input" placeholder="請輸入銀行帳號">
        <div class="error-message" id="accountNumberError">請輸入銀行帳號</div>
      </div>
      <button type="button" class="btn-save" id="savePaymentInfoBtn">
        <<i class="fa-solid fa-save"></</i> 儲存資訊
      </button>
      <div class="save-success" id="saveSuccess">✅ 儲存成功！</div>
    </form>
  </div>

  <!-- 統計卡片 -->
  <div class="stats-container">
    <div class="stat-card">
      <h3>總用戶數</h3>
      <div class="value" id="totalTenants">0</div>
      <div class="desc">已註冊租客</div>
    </div>
    <div class="stat-card">
      <h3>總相簿數</h3>
      <div class="value" id="totalAlbums">0</div>
      <div class="desc">所有房間相簿</div>
    </div>
    <div class="stat-card">
      <h3>總繳費記錄</h3>
      <div class="value" id="totalPayments">0</div>
      <div class="desc">總繳費數</div>
    </div>
    <div class="stat-card">
      <h3>總金額</h3>
      <div class="value" id="totalAmountSum">$0</div>
      <div class="desc">累計收入</div>
    </div>
  </div>

  <!-- 後台標籤 -->
  <div class="admin-tabs">
    <div class="admin-tab active" data-tab="tenant">用戶管理</div>
    <div class="admin-tab" data-tab="album">相簿管理</div>
    <div class="admin-tab" data-tab="payment">繳費記錄管理</div>
  </div>

  <!-- 用戶管理標籤內容 -->
  <div class="table-container tab-content active" id="tenantTabContent">
    <input type="text" class="search-input" placeholder="搜尋用戶姓名、電話或房間號..." id="tenantSearch">
    
    <!-- 批量操作區域 -->
    <div class="batch-actions">
      <input type="checkbox" id="selectAllTenants">
      <label for="selectAllTenants">全選</label>
      <button class="btn-batch-delete" id="batchDeleteTenantBtn" disabled>
        <<i class="fa-solid fa-trash"></</i> 批量刪除選中租客
      </button>
    </div>

    <div class="empty-text" id="emptyTenantText">暫無用戶資料</div>
    <table class="tenant-table" id="tenantTable" style="display: none;">
      <thead>
        <tr>
          <<th><input type="checkbox" id="tableSelectAllTenants"></</th>
          <<th>姓名</</th>
          <<th>電話</</th>
          <<th>信箱</</th>
          <<th>房號</</th>
          <<th>MEGA文件夾</</th>
          <<th>操作</</th>
        </tr>
      </thead>
      <tbody id="tenantTableBody"></tbody>
    </table>
  </div>

  <!-- 相簿管理標籤內容 -->
  <div class="table-container tab-content" id="albumTabContent">
    <button class="btn-add" id="addAlbumBtn">
      <<i class="fa-solid fa-plus"></</i> 新增相簿
    </button>
    <input type="text" class="search-input" placeholder="搜尋房間號..." id="albumSearch">
    <div class="empty-text" id="emptyAlbumText">暫無相簿資料</div>
    <table class="album-table" id="albumTable" style="display: none;">
      <thead>
        <tr>
          <<th><input type="checkbox" id="tableSelectAllAlbums"></</th>
          <<th>房號</</th>
          <<th>相簿名稱</</th>
          <<th>圖片數量</</th>
          <<th>建立時間</</th>
          <<th>MEGA文件夾</</th>
          <<th>操作</</th>
        </tr>
      </thead>
      <tbody id="albumTableBody"></tbody>
    </table>
  </div>

  <!-- 繳費記錄管理標籤內容 -->
  <div class="table-container tab-content" id="paymentTabContent">
    <button class="btn-add" id="addPaymentBtn">
      <<i class="fa-solid fa-plus"></</i> 新增繳費記錄
    </button>
    <input type="text" class="search-input" placeholder="搜尋租客姓名、房號或繳費區間..." id="paymentSearch">
    
    <!-- 批量操作區域 -->
    <div class="batch-actions">
      <input type="checkbox" id="selectAllPayments">
      <label for="selectAllPayments">全選</label>
      <button class="btn-batch-delete" id="batchDeletePaymentBtn" disabled>
        <<i class="fa-solid fa-trash"></</i> 批量刪除選中記錄
      </button>
    </div>

    <div class="empty-text" id="emptyPaymentText">暫無繳費記錄</div>
    <table class="payment-table" id="paymentTable" style="display: none;">
      <thead>
        <tr>
          <<th><input type="checkbox" id="tableSelectAllPayments"></</th>
          <<th>租客姓名</</th>
          <<th>房號</</th>
          <<th>租約期間</</th>
          <<th>繳費區間</</th>
          <<th>房租</</th>
          <<th>電費</</th>
          <<th>水費</</th>
          <<th>總金額</</th>
          <<th>匯款日期</</th>
          <<th>匯款後五碼</</th>
          <<th>新增時間</</th>
          <<th>操作</</th>
        </tr>
      </thead>
      <tbody id="paymentTableBody"></tbody>
    </table>
  </div>

  <!-- 新增相簿彈窗 -->
  <div class="modal" id="addAlbumModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">新增相簿</h2>
        <button class="close-modal" id="closeAlbumModal">&times;</button>
      </div>
      <form class="add-album-form" id="addAlbumForm">
        <div class="form-group">
          <label for="albumRoom">房號 *</label>
          <input type="text" id="albumRoom" class="form-input" placeholder="請輸入房號（如：101）">
          <div class="error-message" id="albumRoomError">請輸入房號</div>
        </div>
        <div class="form-group">
          <label for="albumName">相簿名稱 *</label>
          <input type="text" id="albumName" class="form-input" placeholder="請輸入相簿名稱">
          <div class="error-message" id="albumNameError">請輸入相簿名稱</div>
        </div>
        <div class="form-group">
          <label for="albumImageUrls">圖片URL（多張請用逗號分隔）</label>
          <input type="text" id="albumImageUrls" class="form-input" placeholder="https://xxx.jpg,https://yyy.jpg">
        </div>
        <button type="button" class="btn-submit" id="submitAlbumBtn">
          <<i class="fa-solid fa-save"></</i> 新增相簿
        </button>
        <div class="save-success" id="albumSaveSuccess">✅ 新增成功！</div>
      </form>
    </div>
  </div>

  <!-- 新增繳費記錄彈窗 -->
  <div class="modal" id="addPaymentModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">新增繳費記錄</h2>
        <button class="close-modal" id="closePaymentModal">&times;</button>
      </div>
      <form class="add-payment-form" id="addPaymentForm">
        <div class="form-group">
          <label for="paymentTenantName">租客姓名 *</label>
          <input type="text" id="paymentTenantName" class="form-input" placeholder="請輸入租客姓名">
          <div class="error-message" id="paymentTenantNameError">請輸入租客姓名</div>
        </div>
        <div class="form-group">
          <label for="paymentRoom">房號 *</label>
          <input type="text" id="paymentRoom" class="form-input" placeholder="請輸入房號（如：101）">
          <div class="error-message" id="paymentRoomError">請輸入房號</div>
        </div>
        <div class="form-group">
          <label for="paymentRentalPeriod">租約期間</label>
          <input type="text" id="paymentRentalPeriod" class="form-input" placeholder="如：2025/01-2025/12">
        </div>
        <div class="form-group">
          <label for="paymentPeriod">繳費區間 *</label>
          <input type="text" id="paymentPeriod" class="form-input" placeholder="如：2025/01">
          <div class="error-message" id="paymentPeriodError">請輸入繳費區間</div>
        </div>
        <div class="form-group">
          <label for="paymentRent">房租（元） *</label>
          <input type="number" id="paymentRent" class="form-input" placeholder="請輸入房租金額" min="0">
          <div class="error-message" id="paymentRentError">請輸入房租金額</div>
        </div>
        <div class="form-group">
          <label for="paymentElectricity">電費（元）</label>
          <input type="number" id="paymentElectricity" class="form-input" placeholder="請輸入電費金額" min="0" value="0">
        </div>
        <div class="form-group">
          <label for="paymentWater">水費（元）</label>
          <input type="number" id="paymentWater" class="form-input" placeholder="請輸入水費金額" min="0" value="0">
        </div>
        <div class="form-group">
          <label for="paymentDate">匯款日期</label>
          <input type="text" id="paymentDate" class="form-input" placeholder="如：2025/01/15">
        </div>
        <div class="form-group">
          <label for="paymentLast5">匯款後五碼</label>
          <input type="text" id="paymentLast5" class="form-input" placeholder="請輸入匯款帳號後五碼">
        </div>
        <button type="button" class="btn-submit" id="submitPaymentBtn">
          <<i class="fa-solid fa-save"></</i> 新增繳費記錄
        </button>
        <div class="save-success" id="paymentSaveSuccess">✅ 新增成功！</div>
      </form>
    </div>
  </div>

  <script>
    // 全域變量
    let currentEditingAlbumIndex = -1;
    let currentEditingPaymentIndex = -1;

    // 後台標籤切換
    const adminTabs = document.querySelectorAll('.admin-tab');
    const tabContents = document.querySelectorAll('.tab-content');
    
    adminTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        adminTabs.forEach(t => t.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));
        
        tab.classList.add('active');
        const tabId = tab.getAttribute('data-tab');
        document.getElementById(`${tabId}TabContent`).classList.add('active');
        
        if (tabId === 'album') loadAlbumData();
        if (tabId === 'payment') loadPaymentRecords();
      });
    });

    // 登出功能
    document.getElementById('logoutBtn').addEventListener('click', () => {
      if (confirm('確定要登出嗎？')) {
        window.location.href = 'index.html';
      }
    });

    // ========== 繳租銀行資訊設定 ==========
    const bankNameInput = document.getElementById('bankName');
    const branchNameInput = document.getElementById('branchName');
    const accountNameInput = document.getElementById('accountName');
    const accountNumberInput = document.getElementById('accountNumber');
    const savePaymentInfoBtn = document.getElementById('savePaymentInfoBtn');
    const saveSuccess = document.getElementById('saveSuccess');
    
    const bankNameError = document.getElementById('bankNameError');
    const branchNameError = document.getElementById('branchNameError');
    const accountNameError = document.getElementById('accountNameError');
    const accountNumberError = document.getElementById('accountNumberError');

    // 表單驗證函數
    function validateForm() {
      let isValid = true;
      
      [bankNameInput, branchNameInput, accountNameInput, accountNumberInput].forEach(input => {
        input.classList.remove('error');
      });
      [bankNameError, branchNameError, accountNameError, accountNumberError].forEach(error => {
        error.style.display = 'none';
      });

      if (!bankNameInput.value.trim()) {
        bankNameInput.classList.add('error');
        bankNameError.style.display = 'block';
        isValid = false;
      }

      if (!branchNameInput.value.trim()) {
        branchNameInput.classList.add('error');
        branchNameError.style.display = 'block';
        isValid = false;
      }

      if (!accountNameInput.value.trim()) {
        accountNameInput.classList.add('error');
        accountNameError.style.display = 'block';
        isValid = false;
      }

      if (!accountNumberInput.value.trim()) {
        accountNumberInput.classList.add('error');
        accountNumberError.style.display = 'block';
        isValid = false;
      }

      return isValid;
    }

    // 儲存繳租資訊
    savePaymentInfoBtn.addEventListener('click', () => {
      if (!validateForm()) return;

      savePaymentInfoBtn.disabled = true;
      savePaymentInfoBtn.innerHTML = '<<i class="fa-solid fa-spinner fa-spin"></</i> 處理中...';

      try {
        const paymentInfo = {
          bankName: bankNameInput.value.trim(),
          branchName: branchNameInput.value.trim(),
          accountName: accountNameInput.value.trim(),
          accountNumber: accountNumberInput.value.trim(),
          updateTime: new Date().toLocaleString('zh-TW')
        };

        localStorage.setItem('paymentInfo', JSON.stringify(paymentInfo));
        saveSuccess.style.display = 'block';
        
        setTimeout(() => {
          saveSuccess.style.display = 'none';
          savePaymentInfoBtn.disabled = false;
          savePaymentInfoBtn.innerHTML = '<<i class="fa-solid fa-save"></</i> 儲存資訊';
          
          window.dispatchEvent(new StorageEvent('storage', {
            key: 'paymentInfo',
            newValue: JSON.stringify(paymentInfo)
          }));
        }, 2000);

      } catch (e) {
        console.error('儲存繳租資訊失敗:', e);
        alert('儲存失敗，請稍後再試！');
        savePaymentInfoBtn.disabled = false;
        savePaymentInfoBtn.innerHTML = '<<i class="fa-solid fa-save"></</i> 儲存資訊';
      }
    });

    // 即時清除錯誤提示
    [bankNameInput, branchNameInput, accountNameInput, accountNumberInput].forEach(input => {
      input.addEventListener('input', () => {
        input.classList.remove('error');
        document.getElementById(`${input.id}Error`).style.display = 'none';
      });
    });

    // ========== 頁面加載初始化 ==========
    window.addEventListener('load', () => {
      // 加載繳租資訊
      try {
        const paymentInfo = JSON.parse(localStorage.getItem('paymentInfo')) || {};
        bankNameInput.value = paymentInfo.bankName || '';
        branchNameInput.value = paymentInfo.branchName || '';
        accountNameInput.value = paymentInfo.accountName || '';
        accountNumberInput.value = paymentInfo.accountNumber || '';
      } catch (e) {
        console.error('讀取繳租資訊失敗:', e);
        alert('讀取已保存的繳租資訊失敗，請重新輸入！');
      }

      // 加載各模塊數據
      loadTenantList();
      loadAlbumData();
      loadPaymentRecords();
      loadStatsData();

      // 綁定搜索事件
      bindSearchEvents();

      // 綁定彈窗事件
      bindModalEvents();

      // 綁定全選事件
      bindSelectAllEvents();

      // 綁定新增按鈕事件
      bindAddButtonEvents();
    });

    // ========== 搜索事件綁定 ==========
    function bindSearchEvents() {
      // 租客搜索
      document.getElementById('tenantSearch').addEventListener('input', (e) => {
        const keyword = e.target.value.toLowerCase().trim();
        const rows = document.querySelectorAll('#tenantTableBody tr');
        rows.forEach(row => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(keyword) ? '' : 'none';
        });
      });

      // 相簿搜索
      document.getElementById('albumSearch').addEventListener('input', (e) => {
        const keyword = e.target.value.toLowerCase().trim();
        const rows = document.querySelectorAll('#albumTableBody tr');
        rows.forEach(row => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(keyword) ? '' : 'none';
        });
      });

      // 繳費記錄搜索
      document.getElementById('paymentSearch').addEventListener('input', (e) => {
        const keyword = e.target.value.toLowerCase().trim();
        const rows = document.querySelectorAll('#paymentTableBody tr');
        rows.forEach(row => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(keyword) ? '' : 'none';
        });
      });
    }

    // ========== 彈窗事件綁定 ==========
    function bindModalEvents() {
      // 新增相簿彈窗
      const addAlbumModal = document.getElementById('addAlbumModal');
      const closeAlbumModal = document.getElementById('closeAlbumModal');
      const addAlbumBtn = document.getElementById('addAlbumBtn');

      addAlbumBtn.addEventListener('click', () => {
        currentEditingAlbumIndex = -1;
        resetAlbumForm();
        addAlbumModal.style.display = 'flex';
      });

      closeAlbumModal.addEventListener('click', () => {
        addAlbumModal.style.display = 'none';
      });

      // 新增繳費記錄彈窗
      const addPaymentModal = document.getElementById('addPaymentModal');
      const closePaymentModal = document.getElementById('closePaymentModal');
      const addPaymentBtn = document.getElementById('addPaymentBtn');

      addPaymentBtn.addEventListener('click', () => {
        currentEditingPaymentIndex = -1;
        resetPaymentForm();
        addPaymentModal.style.display = 'flex';
      });

      closePaymentModal.addEventListener('click', () => {
        addPaymentModal.style.display = 'none';
      });

      // 點擊彈窗外關閉
      window.addEventListener('click', (e) => {
        if (e.target === addAlbumModal) addAlbumModal.style.display = 'none';
        if (e.target === addPaymentModal) addPaymentModal.style.display = 'none';
      });
    }

    // ========== 新增按鈕事件綁定 ==========
    function bindAddButtonEvents() {
      // 提交相簿
      document.getElementById('submitAlbumBtn').addEventListener('click', submitAlbum);

      // 提交繳費記錄
      document.getElementById('submitPaymentBtn').addEventListener('click', submitPayment);
    }

    // ========== 全選事件綁定 ==========
    function bindSelectAllEvents() {
      // 租客全選
      const selectAllTenants = document.getElementById('selectAllTenants');
      const tableSelectAllTenants = document.getElementById('tableSelectAllTenants');
      const batchDeleteTenantBtn = document.getElementById('batchDeleteTenantBtn');

      selectAllTenants.addEventListener('change', (e) => {
        const isChecked = e.target.checked;
        tableSelectAllTenants.checked = isChecked;
        document.querySelectorAll('.tenant-checkbox').forEach(checkbox => {
          checkbox.checked = isChecked;
        });
        batchDeleteTenantBtn.disabled = !isChecked;
      });

      tableSelectAllTenants.addEventListener('change', (e) => {
        const isChecked = e.target.checked;
        selectAllTenants.checked = isChecked;
        document.querySelectorAll('.tenant-checkbox').forEach(checkbox => {
          checkbox.checked = isChecked;
        });
        batchDeleteTenantBtn.disabled = !isChecked;
      });

      // 繳費記錄全選
      const selectAllPayments = document.getElementById('selectAllPayments');
      const tableSelectAllPayments = document.getElementById('tableSelectAllPayments');
      const batchDeletePaymentBtn = document.getElementById('batchDeletePaymentBtn');

      selectAllPayments.addEventListener('change', (e) => {
        const isChecked = e.target.checked;
        tableSelectAllPayments.checked = isChecked;
        document.querySelectorAll('.payment-checkbox').forEach(checkbox => {
          checkbox.checked = isChecked;
        });
        batchDeletePaymentBtn.disabled = !isChecked;
      });

      tableSelectAllPayments.addEventListener('change', (e) => {
        const isChecked = e.target.checked;
        selectAllPayments.checked = isChecked;
        document.querySelectorAll('.payment-checkbox').forEach(checkbox => {
          checkbox.checked = isChecked;
        });
        batchDeletePaymentBtn.disabled = !isChecked;
      });

      // 相簿全選
      const tableSelectAllAlbums = document.getElementById('tableSelectAllAlbums');
      tableSelectAllAlbums.addEventListener('change', (e) => {
        const isChecked = e.target.checked;
        document.querySelectorAll('.album-checkbox').forEach(checkbox => {
          checkbox.checked = isChecked;
        });
      });

      // 綁定批量刪除事件
      batchDeleteTenantBtn.addEventListener('click', batchDeleteTenants);
      batchDeletePaymentBtn.addEventListener('click', batchDeletePayments);
    }

    // ========== 租客管理 ==========
    function loadTenantList() {
      let tenants = [];
      try {
        const storedTenants = localStorage.getItem('gdcTenants');
        if (storedTenants) {
          tenants = JSON.parse(storedTenants);
          if (!Array.isArray(tenants)) tenants = [];
        }
      } catch (e) {
        console.error('讀取租客列表失敗:', e);
        tenants = [];
      }

      const emptyText = document.getElementById('emptyTenantText');
      const tenantTable = document.getElementById('tenantTable');
      const tenantTableBody = document.getElementById('tenantTableBody');
      const totalTenants = document.getElementById('totalTenants');
            // 更新統計數據
      totalTenants.textContent = tenants.length;

      // 渲染表格
      if (tenants.length === 0) {
        emptyText.style.display = 'block';
        tenantTable.style.display = 'none';
      } else {
        emptyText.style.display = 'none';
        tenantTable.style.display = 'table';
        tenantTableBody.innerHTML = '';

        tenants.forEach((tenant, index) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><input type="checkbox" class="tenant-checkbox" data-index="${index}"></td>
            <td>${tenant.name || '-'}</td>
            <td>${tenant.phone || '-'}</td>
            <td>${tenant.email || '-'}</td>
            <td>${tenant.room || '-'}</td>
            <td>${tenant.megaLink ? `<a href="${tenant.megaLink}" target="_blank" class="mega-link">查看</a>` : '-'}</td>
            <td>
              <button class="btn-delete tenant-delete-btn" data-index="${index}">
                <i class="fa-solid fa-trash"></i> 刪除
              </button>
            </td>
          `;
          tenantTableBody.appendChild(tr);
        });

        // 綁定單個刪除事件
        document.querySelectorAll('.tenant-delete-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.closest('.tenant-delete-btn').dataset.index);
            deleteTenant(index);
          });
        });

        // 監聽租客勾選狀態
        document.querySelectorAll('.tenant-checkbox').forEach(checkbox => {
          checkbox.addEventListener('change', updateTenantBatchButton);
        });
      }
    }

    // 更新租客批量刪除按鈕狀態
    function updateTenantBatchButton() {
      const checkedCount = document.querySelectorAll('.tenant-checkbox:checked').length;
      document.getElementById('batchDeleteTenantBtn').disabled = checkedCount === 0;
    }

    // 刪除單個租客
    function deleteTenant(index) {
      if (!confirm('確定要刪除此租客嗎？此操作不可復原！')) return;

      try {
        let tenants = JSON.parse(localStorage.getItem('gdcTenants')) || [];
        tenants.splice(index, 1);
        localStorage.setItem('gdcTenants', JSON.stringify(tenants));
        loadTenantList();
        loadStatsData();
        alert('刪除成功！');
      } catch (e) {
        console.error('刪除租客失敗:', e);
        alert('刪除失敗，請稍後再試！');
      }
    }

    // 批量刪除租客
    function batchDeleteTenants() {
      const checkedCheckboxes = document.querySelectorAll('.tenant-checkbox:checked');
      if (checkedCheckboxes.length === 0) return;

      if (!confirm(`確定要刪除選中的 ${checkedCheckboxes.length} 個租客嗎？此操作不可復原！`)) return;

      try {
        let tenants = JSON.parse(localStorage.getItem('gdcTenants')) || [];
        // 獲取要刪除的索引並降序排列（避免刪除時索引偏移）
        const indexes = Array.from(checkedCheckboxes)
          .map(checkbox => parseInt(checkbox.dataset.index))
          .sort((a, b) => b - a);

        // 刪除對應租客
        indexes.forEach(index => {
          if (index >= 0 && index < tenants.length) {
            tenants.splice(index, 1);
          }
        });

        localStorage.setItem('gdcTenants', JSON.stringify(tenants));
        loadTenantList();
        loadStatsData();
        alert(`成功刪除 ${indexes.length} 個租客！`);
      } catch (e) {
        console.error('批量刪除租客失敗:', e);
        alert('批量刪除失敗，請稍後再試！');
      }
    }

    // ========== 相簿管理 ==========
    function loadAlbumData() {
      let albums = [];
      try {
        const storedAlbums = localStorage.getItem('gdcAlbums');
        if (storedAlbums) {
          albums = JSON.parse(storedAlbums);
          if (!Array.isArray(albums)) albums = [];
        }
      } catch (e) {
        console.error('讀取相簿列表失敗:', e);
        albums = [];
      }

      const emptyText = document.getElementById('emptyAlbumText');
      const albumTable = document.getElementById('albumTable');
      const albumTableBody = document.getElementById('albumTableBody');
      const totalAlbums = document.getElementById('totalAlbums');

      // 更新統計數據
      totalAlbums.textContent = albums.length;

      // 渲染表格
      if (albums.length === 0) {
        emptyText.style.display = 'block';
        albumTable.style.display = 'none';
      } else {
        emptyText.style.display = 'none';
        albumTable.style.display = 'table';
        albumTableBody.innerHTML = '';

        albums.forEach((album, index) => {
          const imageCount = album.images && Array.isArray(album.images) ? album.images.length : 0;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><input type="checkbox" class="album-checkbox" data-index="${index}"></td>
            <td>${album.room || '-'}</td>
            <td>${album.name || '-'}</td>
            <td>${imageCount}</td>
            <td>${album.createTime || '-'}</td>
            <td>${album.megaLink ? `<a href="${album.megaLink}" target="_blank" class="mega-link">查看</a>` : '-'}</td>
            <td>
              <button class="btn-view album-view-btn" data-index="${index}">
                <i class="fa-solid fa-eye"></i> 查看
              </button>
              <button class="btn-edit album-edit-btn" data-index="${index}">
                <i class="fa-solid fa-pen"></i> 編輯
              </button>
              <button class="btn-delete album-delete-btn" data-index="${index}">
                <i class="fa-solid fa-trash"></i> 刪除
              </button>
            </td>
          `;
          albumTableBody.appendChild(tr);
        });

        // 綁定相簿按鈕事件
        document.querySelectorAll('.album-view-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.closest('.album-view-btn').dataset.index);
            viewAlbum(index);
          });
        });

        document.querySelectorAll('.album-edit-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.closest('.album-edit-btn').dataset.index);
            editAlbum(index);
          });
        });

        document.querySelectorAll('.album-delete-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.closest('.album-delete-btn').dataset.index);
            deleteAlbum(index);
          });
        });
      }
    }

    // 重置相簿表單
    function resetAlbumForm() {
      const albumRoom = document.getElementById('albumRoom');
      const albumName = document.getElementById('albumName');
      const albumImageUrls = document.getElementById('albumImageUrls');
      const albumRoomError = document.getElementById('albumRoomError');
      const albumNameError = document.getElementById('albumNameError');
      const albumSaveSuccess = document.getElementById('albumSaveSuccess');

      albumRoom.value = '';
      albumName.value = '';
      albumImageUrls.value = '';
      albumRoom.classList.remove('error');
      albumName.classList.remove('error');
      albumRoomError.style.display = 'none';
      albumNameError.style.display = 'none';
      albumSaveSuccess.style.display = 'none';
    }

    // 提交相簿（新增/編輯）
    function submitAlbum() {
      const albumRoom = document.getElementById('albumRoom');
      const albumName = document.getElementById('albumName');
      const albumImageUrls = document.getElementById('albumImageUrls');
      const albumRoomError = document.getElementById('albumRoomError');
      const albumNameError = document.getElementById('albumNameError');
      const albumSaveSuccess = document.getElementById('albumSaveSuccess');
      const submitAlbumBtn = document.getElementById('submitAlbumBtn');

      // 驗證
      let isValid = true;
      albumRoom.classList.remove('error');
      albumName.classList.remove('error');
      albumRoomError.style.display = 'none';
      albumNameError.style.display = 'none';

      if (!albumRoom.value.trim()) {
        albumRoom.classList.add('error');
        albumRoomError.style.display = 'block';
        isValid = false;
      }

      if (!albumName.value.trim()) {
        albumName.classList.add('error');
        albumNameError.style.display = 'block';
        isValid = false;
      }

      if (!isValid) return;

      // 處理圖片URL
      let images = [];
      if (albumImageUrls.value.trim()) {
        images = albumImageUrls.value.split(',').map(url => url.trim()).filter(url => url);
      }

      // 構建相簿數據
      const albumData = {
        room: albumRoom.value.trim(),
        name: albumName.value.trim(),
        images: images,
        createTime: currentEditingAlbumIndex === -1 
          ? new Date().toLocaleString('zh-TW') 
          : getAlbumByIdx(currentEditingAlbumIndex).createTime,
        megaLink: getAlbumByIdx(currentEditingAlbumIndex)?.megaLink || ''
      };

      submitAlbumBtn.disabled = true;
      submitAlbumBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 處理中...';

      try {
        let albums = JSON.parse(localStorage.getItem('gdcAlbums')) || [];
        if (!Array.isArray(albums)) albums = [];

        if (currentEditingAlbumIndex === -1) {
          // 新增
          albums.push(albumData);
        } else {
          // 編輯
          albums[currentEditingAlbumIndex] = albumData;
        }

        localStorage.setItem('gdcAlbums', JSON.stringify(albums));
        albumSaveSuccess.style.display = 'block';

        setTimeout(() => {
          document.getElementById('addAlbumModal').style.display = 'none';
          resetAlbumForm();
          loadAlbumData();
          loadStatsData();
          submitAlbumBtn.disabled = false;
          submitAlbumBtn.innerHTML = '<i class="fa-solid fa-save"></i> 新增相簿';
          alert(currentEditingAlbumIndex === -1 ? '相簿新增成功！' : '相簿編輯成功！');
        }, 1500);

      } catch (e) {
        console.error('保存相簿失敗:', e);
        alert('保存失敗，請稍後再試！');
        submitAlbumBtn.disabled = false;
        submitAlbumBtn.innerHTML = '<i class="fa-solid fa-save"></i> 新增相簿';
      }
    }

    // 根據索引獲取相簿
    function getAlbumByIdx(index) {
      try {
        const albums = JSON.parse(localStorage.getItem('gdcAlbums')) || [];
        return albums[index] || {};
      } catch (e) {
        return {};
      }
    }

    // 查看相簿
    function viewAlbum(index) {
      const album = getAlbumByIdx(index);
      if (!album) return;

      // 創建彈窗顯示圖片
      const modal = document.createElement('div');
      modal.style.position = 'fixed';
      modal.style.top = '0';
      modal.style.left = '0';
      modal.style.width = '100%';
      modal.style.height = '100%';
      modal.style.backgroundColor = 'rgba(0,0,0,0.8)';
      modal.style.zIndex = '99999';
      modal.style.display = 'flex';
      modal.style.flexDirection = 'column';
      modal.style.justifyContent = 'center';
      modal.style.alignItems = 'center';

      const header = document.createElement('div');
      header.style.color = 'white';
      header.style.fontSize = '20px';
      header.style.marginBottom = '20px';
      header.style.textAlign = 'center';
      header.innerHTML = `<strong>${album.room} - ${album.name}</strong>`;

      const closeBtn = document.createElement('button');
      closeBtn.style.position = 'absolute';
      closeBtn.style.top = '20px';
      closeBtn.style.right = '20px';
      closeBtn.style.backgroundColor = 'red';
      closeBtn.style.color = 'white';
      closeBtn.style.border = 'none';
      closeBtn.style.borderRadius = '50%';
      closeBtn.style.width = '40px';
      closeBtn.style.height = '40px';
      closeBtn.style.fontSize = '20px';
      closeBtn.style.cursor = 'pointer';
      closeBtn.textContent = '×';

      const imagesGrid = document.createElement('div');
      imagesGrid.className = 'images-grid';
      imagesGrid.style.maxWidth = '90%';
      imagesGrid.style.maxHeight = '80%';
      imagesGrid.style.overflowY = 'auto';
      imagesGrid.style.padding = '20px';

      // 添加圖片
      if (album.images && album.images.length > 0) {
        album.images.forEach(imgUrl => {
          const imgItem = document.createElement('div');
          imgItem.className = 'image-item';
          const img = document.createElement('img');
          img.src = imgUrl;
          img.alt = album.name;
          img.onerror = () => {
            img.src = 'https://via.placeholder.com/150?text=圖片加載失敗';
          };
          imgItem.appendChild(img);
          imagesGrid.appendChild(imgItem);
        });
      } else {
        imagesGrid.innerHTML = '<div style="color:white; padding:50px;">此相簿暫無圖片</div>';
      }

      modal.appendChild(closeBtn);
      modal.appendChild(header);
      modal.appendChild(imagesGrid);
      document.body.appendChild(modal);

      // 關閉事件
      closeBtn.addEventListener('click', () => {
        document.body.removeChild(modal);
      });

      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          document.body.removeChild(modal);
        }
      });
    }

    // 編輯相簿
    function editAlbum(index) {
      const album = getAlbumByIdx(index);
      if (!album) return;

      currentEditingAlbumIndex = index;
      const albumRoom = document.getElementById('albumRoom');
      const albumName = document.getElementById('albumName');
      const albumImageUrls = document.getElementById('albumImageUrls');

      // 填充表單
      albumRoom.value = album.room || '';
      albumName.value = album.name || '';
      albumImageUrls.value = album.images ? album.images.join(',') : '';

      // 打開彈窗
      document.getElementById('addAlbumModal').style.display = 'flex';
      document.querySelector('.modal-title').textContent = '編輯相簿';
      document.getElementById('submitAlbumBtn').innerHTML = '<i class="fa-solid fa-save"></i> 保存修改';
    }

    // 刪除相簿
    function deleteAlbum(index) {
      if (!confirm('確定要刪除此相簿嗎？此操作不可復原！')) return;

      try {
        let albums = JSON.parse(localStorage.getItem('gdcAlbums')) || [];
        albums.splice(index, 1);
        localStorage.setItem('gdcAlbums', JSON.stringify(albums));
        loadAlbumData();
        loadStatsData();
        alert('相簿刪除成功！');
      } catch (e) {
        console.error('刪除相簿失敗:', e);
        alert('刪除失敗，請稍後再試！');
      }
    }

    // ========== 繳費記錄管理 ==========
    function loadPaymentRecords() {
      let payments = [];
      try {
        const storedPayments = localStorage.getItem('gdcPayments');
        if (storedPayments) {
          payments = JSON.parse(storedPayments);
          if (!Array.isArray(payments)) payments = [];
        }
      } catch (e) {
        console.error('讀取繳費記錄失敗:', e);
        payments = [];
      }

      const emptyText = document.getElementById('emptyPaymentText');
      const paymentTable = document.getElementById('paymentTable');
      const paymentTableBody = document.getElementById('paymentTableBody');
      const totalPayments = document.getElementById('totalPayments');

      // 更新統計數據
      totalPayments.textContent = payments.length;

      // 渲染表格
      if (payments.length === 0) {
        emptyText.style.display = 'block';
        paymentTable.style.display = 'none';
      } else {
        emptyText.style.display = 'none';
        paymentTable.style.display = 'table';
        paymentTableBody.innerHTML = '';

        payments.forEach((payment, index) => {
          // 計算總金額
          const rent = parseFloat(payment.rent) || 0;
          const electricity = parseFloat(payment.electricity) || 0;
          const water = parseFloat(payment.water) || 0;
          const total = rent + electricity + water;

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><input type="checkbox" class="payment-checkbox" data-index="${index}"></td>
            <td>${payment.tenantName || '-'}</td>
            <td>${payment.room || '-'}</td>
            <td>${payment.rentalPeriod || '-'}</td>
            <td>${payment.period || '-'}</td>
            <td>$${rent.toLocaleString()}</td>
            <td>$${electricity.toLocaleString()}</td>
            <td>$${water.toLocaleString()}</td>
            <td>$${total.toLocaleString()}</td>
            <td>${payment.paymentDate || '-'}</td>
            <td>${payment.last5 || '-'}</td>
            <td>${payment.createTime || '-'}</td>
            <td>
              <button class="btn-edit payment-edit-btn" data-index="${index}">
                <i class="fa-solid fa-pen"></i> 編輯
              </button>
              <button class="btn-delete payment-delete-btn" data-index="${index}">
                <i class="fa-solid fa-trash"></i> 刪除
              </button>
            </td>
          `;
          paymentTableBody.appendChild(tr);
        });

        // 綁定繳費記錄按鈕事件
        document.querySelectorAll('.payment-edit-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.closest('.payment-edit-btn').dataset.index);
            editPayment(index);
          });
        });

        document.querySelectorAll('.payment-delete-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.closest('.payment-delete-btn').dataset.index);
            deletePayment(index);
          });
        });

        // 監聽繳費記錄勾選狀態
        document.querySelectorAll('.payment-checkbox').forEach(checkbox => {
          checkbox.addEventListener('change', updatePaymentBatchButton);
        });
      }
    }

    // 更新繳費記錄批量刪除按鈕狀態
    function updatePaymentBatchButton() {
      const checkedCount = document.querySelectorAll('.payment-checkbox:checked').length;
      document.getElementById('batchDeletePaymentBtn').disabled = checkedCount === 0;
    }

    // 重置繳費記錄表單
    function resetPaymentForm() {
      const formElements = [
        'paymentTenantName', 'paymentRoom', 'paymentRentalPeriod', 
        'paymentPeriod', 'paymentRent', 'paymentElectricity', 
        'paymentWater', 'paymentDate', 'paymentLast5'
      ];
      
      formElements.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
        const errorEl = document.getElementById(`${id}Error`);
        if (errorEl) {
          errorEl.style.display = 'none';
          el.classList.remove('error');
        }
      });
      
      document.getElementById('paymentSaveSuccess').style.display = 'none';
      document.querySelector('.modal-title').textContent = '新增繳費記錄';
      document.getElementById('submitPaymentBtn').innerHTML = '<i class="fa-solid fa-save"></i> 新增繳費記錄';
    }

    // 提交繳費記錄（新增/編輯）
    function submitPayment() {
      const paymentTenantName = document.getElementById('paymentTenantName');
      const paymentRoom = document.getElementById('paymentRoom');
      const paymentPeriod = document.getElementById('paymentPeriod');
      const paymentRent = document.getElementById('paymentRent');
      const paymentElectricity = document.getElementById('paymentElectricity');
      const paymentWater = document.getElementById('paymentWater');
      const paymentDate = document.getElementById('paymentDate');
      const paymentLast5 = document.getElementById('paymentLast5');
      const paymentRentalPeriod = document.getElementById('paymentRentalPeriod');
      
      const errorElements = [
        'paymentTenantNameError', 'paymentRoomError', 
        'paymentPeriodError', 'paymentRentError'
      ];

      // 驗證
      let isValid = true;
      
      // 清除所有錯誤提示
      [paymentTenantName, paymentRoom, paymentPeriod, paymentRent].forEach(el => {
        el.classList.remove('error');
        const errorEl = document.getElementById(`${el.id}Error`);
        if (errorEl) errorEl.style.display = 'none';
      });

      if (!paymentTenantName.value.trim()) {
        paymentTenantName.classList.add('error');
        document.getElementById('paymentTenantNameError').style.display = 'block';
        isValid = false;
      }

      if (!paymentRoom.value.trim()) {
        paymentRoom.classList.add('error');
        document.getElementById('paymentRoomError').style.display = 'block';
        isValid = false;
      }

      if (!paymentPeriod.value.trim()) {
        paymentPeriod.classList.add('error');
        document.getElementById('paymentPeriodError').style.display = 'block';
        isValid = false;
      }

      if (!paymentRent.value.trim() || isNaN(parseFloat(paymentRent.value))) {
        paymentRent.classList.add('error');
        document.getElementById('paymentRentError').style.display = 'block';
        isValid = false;
      }

      if (!isValid) return;

      // 構建繳費記錄數據
      const paymentData = {
        tenantName: paymentTenantName.value.trim(),
        room: paymentRoom.value.trim(),
        rentalPeriod: paymentRentalPeriod.value.trim() || '',
        period: paymentPeriod.value.trim(),
        rent: parseFloat(paymentRent.value) || 0,
        electricity: parseFloat(paymentElectricity.value) || 0,
        water: parseFloat(paymentWater.value) || 0,
        paymentDate: paymentDate.value.trim() || '',
        last5: paymentLast5.value.trim() || '',
        createTime: currentEditingPaymentIndex === -1 
          ? new Date().toLocaleString('zh-TW') 
          : getPaymentByIdx(currentEditingPaymentIndex).createTime
      };

      const submitPaymentBtn = document.getElementById('submitPaymentBtn');
      submitPaymentBtn.disabled = true;
      submitPaymentBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 處理中...';

      try {
        let payments = JSON.parse(localStorage.getItem('gdcPayments')) || [];
        if (!Array.isArray(payments)) payments = [];

        if (currentEditingPaymentIndex === -1) {
          // 新增
          payments.push(paymentData);
        } else {
          // 編輯
          payments[currentEditingPaymentIndex] = paymentData;
        }

        localStorage.setItem('gdcPayments', JSON.stringify(payments));
        document.getElementById('paymentSaveSuccess').style.display = 'block';

        setTimeout(() => {
          document.getElementById('addPaymentModal').style.display = 'none';
          resetPaymentForm();
          loadPaymentRecords();
          loadStatsData();
          submitPaymentBtn.disabled = false;
          submitPaymentBtn.innerHTML = '<i class="fa-solid fa-save"></i> 新增繳費記錄';
          alert(currentEditingPaymentIndex === -1 ? '繳費記錄新增成功！' : '繳費記錄編輯成功！');
        }, 1500);

      } catch (e) {
        console.error('保存繳費記錄失敗:', e);
        alert('保存失敗，請稍後再試！');
        submitPaymentBtn.disabled = false;
        submitPaymentBtn.innerHTML = '<i class="fa-solid fa-save"></i> 新增繳費記錄';
      }
    }

    // 根據索引獲取繳費記錄
    function getPaymentByIdx(index) {
      try {
        const payments = JSON.parse(localStorage.getItem('gdcPayments')) || [];
        return payments[index] || {};
      } catch (e) {
        return {};
      }
    }

    // 編輯繳費記錄
    function editPayment(index) {
      const payment = getPaymentByIdx(index);
      if (!payment) return;

      currentEditingPaymentIndex = index;
      
      // 填充表單
      document.getElementById('paymentTenantName').value = payment.tenantName || '';
      document.getElementById('paymentRoom').value = payment.room || '';
      document.getElementById('paymentRentalPeriod').value = payment.rentalPeriod || '';
      document.getElementById('paymentPeriod').value = payment.period || '';
      document.getElementById('paymentRent').value = payment.rent || '';
      document.getElementById('paymentElectricity').value = payment.electricity || '';
      document.getElementById('paymentWater').value = payment.water || '';
      document.getElementById('paymentDate').value = payment.paymentDate || '';
      document.getElementById('paymentLast5').value = payment.last5 || '';

      // 打開彈窗
      document.getElementById('addPaymentModal').style.display = 'flex';
      document.querySelector('.modal-title').textContent = '編輯繳費記錄';
      document.getElementById('submitPaymentBtn').innerHTML = '<i class="fa-solid fa-save"></i> 保存修改';
    }

    // 刪除單個繳費記錄
    function deletePayment(index) {
      if (!confirm('確定要刪除此繳費記錄嗎？此操作不可復原！')) return;

      try {
        let payments = JSON.parse(localStorage.getItem('gdcPayments')) || [];
        payments.splice(index, 1);
        localStorage.setItem('gdcPayments', JSON.stringify(payments));
        loadPaymentRecords();
        loadStatsData();
        alert('繳費記錄刪除成功！');
      } catch (e) {
        console.error('刪除繳費記錄失敗:', e);
        alert('刪除失敗，請稍後再試！');
      }
    }

    // 批量刪除繳費記錄
    function batchDeletePayments() {
      const checkedCheckboxes = document.querySelectorAll('.payment-checkbox:checked');
      if (checkedCheckboxes.length === 0) return;

      if (!confirm(`確定要刪除選中的 ${checkedCheckboxes.length} 條繳費記錄嗎？此操作不可復原！`)) return;

      try {
        let payments = JSON.parse(localStorage.getItem('gdcPayments')) || [];
        // 獲取要刪除的索引並降序排列
        const indexes = Array.from(checkedCheckboxes)
          .map(checkbox => parseInt(checkbox.dataset.index))
          .sort((a, b) => b - a);

        // 刪除對應記錄
        indexes.forEach(index => {
          if (index >= 0 && index < payments.length) {
            payments.splice(index, 1);
          }
        });

        localStorage.setItem('gdcPayments', JSON.stringify(payments));
        loadPaymentRecords();
        loadStatsData();
        alert(`成功刪除 ${indexes.length} 條繳費記錄！`);
      } catch (e) {
        console.error('批量刪除繳費記錄失敗:', e);
        alert('批量刪除失敗，請稍後再試！');
      }
    }

    // ========== 統計數據 ==========
    function loadStatsData() {
      try {
        // 計算總金額
        let totalAmount = 0;
        const payments = JSON.parse(localStorage.getItem('gdcPayments')) || [];
        payments.forEach(payment => {
          const rent = parseFloat(payment.rent) || 0;
          const electricity = parseFloat(payment.electricity) || 0;
          const water = parseFloat(payment.water) || 0;
          totalAmount += rent + electricity + water;
        });

        // 更新總金額顯示
        document.getElementById('totalAmountSum').textContent = `$${totalAmount.toLocaleString()}`;

        // 更新其他統計（租客、相簿、繳費記錄數量已在各自加載函數中更新）
      } catch (e) {
        console.error('加載統計數據失敗:', e);
        document.getElementById('totalAmountSum').textContent = '$0';
      }
    }

    // ========== 表單即時驗證 ==========
    // 相簿表單
    document.getElementById('albumRoom').addEventListener('input', function() {
      this.classList.remove('error');
      document.getElementById('albumRoomError').style.display = 'none';
    });

    document.getElementById('albumName').addEventListener('input', function() {
      this.classList.remove('error');
      document.getElementById('albumNameError').style.display = 'none';
    });

    // 繳費記錄表單
    document.getElementById('paymentTenantName').addEventListener('input', function() {
      this.classList.remove('error');
      document.getElementById('paymentTenantNameError').style.display = 'none';
    });

    document.getElementById('paymentRoom').addEventListener('input', function() {
      this.classList.remove('error');
      document.getElementById('paymentRoomError').style.display = 'none';
    });

    document.getElementById('paymentPeriod').addEventListener('input', function() {
      this.classList.remove('error');
      document.getElementById('paymentPeriodError').style.display = 'none';
    });

    document.getElementById('paymentRent').addEventListener('input', function() {
      this.classList.remove('error');
      document.getElementById('paymentRentError').style.display = 'none';
    });
  </script>
</body>
</html>