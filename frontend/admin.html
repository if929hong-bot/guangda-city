<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>廣大城租客管理系統 - 管理員</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* ... (保持原有的 CSS 樣式不變) ... */
    </style>
</head>
<body>
    <!-- ... (保持原有的 HTML 結構不變) ... -->

    <script src="/js/api.js"></script>
    <script src="/js/admin.js"></script>
    
    <script>
        // 檢查用戶是否已登入
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化管理員資訊
            const user = api.getUserInfo();
            if (user) {
                document.getElementById('adminName').textContent = user.name || user.username;
                if (user.phone) {
                    document.getElementById('adminPhone').textContent = `電話: ${user.phone}`;
                }
            } else {
                // 未登入，跳轉到登入頁面
                window.location.href = 'login.html';
                return;
            }
            
            // 初始化事件監聽器
            initEventListeners();
            
            // 載入租客選項和初始數據
            loadInitialData();
        });
        
        // 初始化事件監聽器
        function initEventListeners() {
            // 繳費記錄搜索按鈕
            const paymentSearchBtn = document.getElementById('paymentSearchBtn');
            if (paymentSearchBtn) {
                paymentSearchBtn.addEventListener('click', () => {
                    loadPaymentsWithPagination(1);
                });
            }
            
            // 繳費記錄搜索輸入框
            const paymentSearchInput = document.getElementById('paymentSearch');
            if (paymentSearchInput) {
                paymentSearchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        loadPaymentsWithPagination(1);
                    }
                });
            }
            
            // 圖片搜索按鈕
            const imageSearchBtn = document.getElementById('imageSearchBtn');
            if (imageSearchBtn) {
                imageSearchBtn.addEventListener('click', () => {
                    loadImagesWithPagination(1);
                });
            }
            
            // 圖片搜索輸入框
            const imageSearchInput = document.getElementById('imageSearch');
            if (imageSearchInput) {
                imageSearchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        loadImagesWithPagination(1);
                    }
                });
            }
        }
        
        // 載入初始數據
        function loadInitialData() {
            // 載入銀行資訊
            loadBankInfo();
            
            // 載入租客選項
            loadTenantOptions();
        }
        
        // 載入租客選項
        async function loadTenantOptions() {
            try {
                const response = await api.adminPaginatedApi.getTenantOptions();
                
                if (response.success && response.data) {
                    // 更新繳費記錄頁面的租客篩選器
                    const tenantFilter = document.getElementById('tenantFilter');
                    if (tenantFilter) {
                        // 保存當前選擇的值
                        const currentValue = tenantFilter.value;
                        
                        // 清空選項（保留第一個選項）
                        while (tenantFilter.options.length > 1) {
                            tenantFilter.remove(1);
                        }
                        
                        // 添加租客選項
                        response.data.forEach(tenant => {
                            const option = document.createElement('option');
                            option.value = tenant.id;
                            option.textContent = `${tenant.name || tenant.username} (${tenant.room_number || '--'})`;
                            tenantFilter.appendChild(option);
                        });
                        
                        // 恢復之前選擇的值
                        if (currentValue && currentValue !== 'all') {
                            tenantFilter.value = currentValue;
                        }
                    }
                    
                    // 更新圖片頁面的租客篩選器
                    const imageTenantFilter = document.getElementById('imageTenantFilter');
                    if (imageTenantFilter) {
                        // 保存當前選擇的值
                        const currentValue = imageTenantFilter.value;
                        
                        // 清空選項（保留第一個選項）
                        while (imageTenantFilter.options.length > 1) {
                            imageTenantFilter.remove(1);
                        }
                        
                        // 添加租客選項
                        response.data.forEach(tenant => {
                            const option = document.createElement('option');
                            option.value = tenant.id;
                            option.textContent = `${tenant.name || tenant.username} (${tenant.room_number || '--'})`;
                            imageTenantFilter.appendChild(option);
                        });
                        
                        // 恢復之前選擇的值
                        if (currentValue && currentValue !== 'all') {
                            imageTenantFilter.value = currentValue;
                        }
                    }
                }
            } catch (error) {
                console.error('載入租客選項失敗:', error);
                showAlert('載入租客選項失敗，請稍後再試', 'error');
            }
        }
        
        // 載入銀行資訊
        async function loadBankInfo() {
            try {
                const response = await api.adminApi.getBankInfo();
                
                if (response.success && response.data) {
                    const bankInfo = response.data;
                    
                    // 填入表單
                    document.getElementById('bankName').value = bankInfo.bank_name || '';
                    document.getElementById('branchName').value = bankInfo.branch_name || '';
                    document.getElementById('accountName').value = bankInfo.account_name || '';
                    document.getElementById('accountNumber').value = bankInfo.account_number || '';
                    
                    // 顯示目前的銀行資訊
                    const displayDiv = document.getElementById('bankInfoDisplay');
                    if (displayDiv) {
                        displayDiv.style.display = 'block';
                        document.getElementById('currentBankName').textContent = bankInfo.bank_name || '未設定';
                        document.getElementById('currentBranchName').textContent = bankInfo.branch_name || '未設定';
                        document.getElementById('currentAccountName').textContent = bankInfo.account_name || '未設定';
                        document.getElementById('currentAccountNumber').textContent = bankInfo.account_number || '未設定';
                        document.getElementById('lastUpdated').textContent = bankInfo.updated_at ? formatDate(bankInfo.updated_at, true) : '未設定';
                    }
                } else {
                    showAlert('載入銀行資訊失敗: ' + (response.message || '未知錯誤'), 'error');
                }
            } catch (error) {
                console.error('載入銀行資訊失敗:', error);
                showAlert('載入銀行資訊失敗，請稍後再試', 'error');
            }
        }
        
        // 儲存銀行資訊
        async function saveBankInfo() {
            const bankInfo = {
                bank_name: document.getElementById('bankName').value.trim(),
                branch_name: document.getElementById('branchName').value.trim(),
                account_name: document.getElementById('accountName').value.trim(),
                account_number: document.getElementById('accountNumber').value.trim()
            };
            
            // 基本驗證
            if (!bankInfo.bank_name || !bankInfo.account_name || !bankInfo.account_number) {
                showAlert('請填寫銀行名稱、戶名和帳號', 'error');
                return;
            }
            
            try {
                const response = await api.adminApi.updateBankInfo(bankInfo);
                
                if (response.success) {
                    showAlert('銀行資訊更新成功', 'success');
                    // 重新載入顯示資訊
                    loadBankInfo();
                } else {
                    showAlert('更新失敗: ' + (response.message || '未知錯誤'), 'error');
                }
            } catch (error) {
                console.error('儲存銀行資訊失敗:', error);
                showAlert('儲存失敗，請稍後再試', 'error');
            }
        }
        
        // 載入所有租客資料
        async function loadAllTenants() {
            const loadingEl = document.getElementById('tenantsLoading');
            const emptyEl = document.getElementById('tenantsEmpty');
            const tableBody = document.querySelector('#tenantsTable tbody');
            
            if (loadingEl) loadingEl.style.display = 'flex';
            if (emptyEl) emptyEl.style.display = 'none';
            if (tableBody) tableBody.innerHTML = '';
            
            try {
                const response = await api.adminApi.getAllTenants();
                
                if (loadingEl) loadingEl.style.display = 'none';
                
                if (response.success && response.data && response.data.length > 0) {
                    // 填充表格
                    tableBody.innerHTML = response.data.map(tenant => `
                        <tr>
                            <td>${escapeHtml(tenant.name || tenant.username)}</td>
                            <td>${escapeHtml(tenant.room_number || '--')}</td>
                            <td>${escapeHtml(tenant.phone || '--')}</td>
                            <td>${escapeHtml(tenant.email || '--')}</td>
                            <td>${tenant.lease_start ? formatDate(tenant.lease_start) : '--'} ~ ${tenant.lease_end ? formatDate(tenant.lease_end) : '--'}</td>
                            <td>NT$ ${tenant.monthly_rent ? tenant.monthly_rent.toLocaleString() : '--'}</td>
                            <td>${tenant.created_at ? formatDate(tenant.created_at, true) : '--'}</td>
                            <td>
                                <div class="action-btns">
                                    <button class="action-btn action-btn-view" onclick="viewTenantDetails(${tenant.id})">
                                        <i class="fas fa-eye"></i> 查看
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    if (emptyEl) emptyEl.style.display = 'block';
                }
            } catch (error) {
                console.error('載入租客資料失敗:', error);
                if (loadingEl) loadingEl.style.display = 'none';
                showAlert('載入租客資料失敗，請稍後再試', 'error');
            }
        }
        
        // 查看租客詳細資訊
        async function viewTenantDetails(tenantId) {
            try {
                const response = await api.adminApi.getTenantDetails(tenantId);
                
                if (response.success && response.data) {
                    const tenant = response.data;
                    
                    // 創建並顯示詳細資訊模態框
                    const modalHtml = `
                        <div class="modal active" id="tenantDetailsModal">
                            <div class="modal-content" style="max-width: 600px;">
                                <div class="modal-header">
                                    <h3><i class="fas fa-user"></i> 租客詳細資訊</h3>
                                    <button class="modal-close" onclick="closeModal('tenantDetailsModal')">&times;</button>
                                </div>
                                <div class="modal-body">
                                    <div class="detail-item">
                                        <div class="detail-label">姓名</div>
                                        <div class="detail-value">${escapeHtml(tenant.name || tenant.username)}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">房號</div>
                                        <div class="detail-value">${escapeHtml(tenant.room_number || '--')}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">電話</div>
                                        <div class="detail-value">${escapeHtml(tenant.phone || '--')}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">Email</div>
                                        <div class="detail-value">${escapeHtml(tenant.email || '--')}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">身分證字號/護照號碼</div>
                                        <div class="detail-value">${escapeHtml(tenant.id_number || '--')}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">緊急聯絡人</div>
                                        <div class="detail-value">${escapeHtml(tenant.emergency_contact || '--')}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">緊急聯絡電話</div>
                                        <div class="detail-value">${escapeHtml(tenant.emergency_phone || '--')}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">租約期間</div>
                                        <div class="detail-value">${tenant.lease_start ? formatDate(tenant.lease_start) : '--'} ~ ${tenant.lease_end ? formatDate(tenant.lease_end) : '--'}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">月租金</div>
                                        <div class="detail-value">NT$ ${tenant.monthly_rent ? tenant.monthly_rent.toLocaleString() : '--'}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">註冊時間</div>
                                        <div class="detail-value">${tenant.created_at ? formatDate(tenant.created_at, true) : '--'}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">最後更新時間</div>
                                        <div class="detail-value">${tenant.updated_at ? formatDate(tenant.updated_at, true) : '--'}</div>
                                    </div>
                                    <div style="margin-top: 20px; text-align: center;">
                                        <button class="btn btn-secondary" onclick="closeModal('tenantDetailsModal')">
                                            <i class="fas fa-times"></i> 關閉
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // 添加模態框到頁面
                    const modalContainer = document.createElement('div');
                    modalContainer.innerHTML = modalHtml;
                    document.body.appendChild(modalContainer);
                } else {
                    showAlert('獲取租客詳細資訊失敗: ' + (response.message || '未知錯誤'), 'error');
                }
            } catch (error) {
                console.error('查看租客詳細資訊失敗:', error);
                showAlert('獲取詳細資訊失敗，請稍後再試', 'error');
            }
        }
        
        // 載入繳費記錄（帶分頁）
        let currentPaymentPage = 1;
        let totalPaymentPages = 1;
        
        async function loadPaymentsWithPagination(page = 1) {
            currentPaymentPage = page;
            
            const loadingEl = document.getElementById('paymentsLoading');
            const emptyEl = document.getElementById('paymentsEmpty');
            const tableBody = document.querySelector('#paymentsTable tbody');
            const paginationEl = document.getElementById('paymentPagination');
            
            if (loadingEl) loadingEl.style.display = 'flex';
            if (emptyEl) emptyEl.style.display = 'none';
            if (tableBody) tableBody.innerHTML = '';
            if (paginationEl) paginationEl.style.display = 'none';
            
            try {
                // 獲取篩選條件
                const filters = {
                    page: page,
                    status: document.getElementById('statusFilter').value,
                    tenant_id: document.getElementById('tenantFilter').value === 'all' ? null : document.getElementById('tenantFilter').value,
                    search: document.getElementById('paymentSearch').value.trim()
                };
                
                const response = await api.adminPaginatedApi.getPayments(filters);
                
                if (loadingEl) loadingEl.style.display = 'none';
                
                if (response.success && response.data) {
                    const payments = response.data.payments || response.data.data || [];
                    totalPaymentPages = response.data.total_pages || 1;
                    
                    if (payments.length > 0) {
                        // 填充表格
                        tableBody.innerHTML = payments.map(payment => `
                            <tr>
                                <td>${escapeHtml(payment.tenant_name || '--')}</td>
                                <td>${escapeHtml(payment.room_number || '--')}</td>
                                <td>${payment.payment_date ? formatDate(payment.payment_date) : '--'}</td>
                                <td>NT$ ${payment.rent_amount ? payment.rent_amount.toLocaleString() : '--'}</td>
                                <td>NT$ ${payment.water_fee ? payment.water_fee.toLocaleString() : '--'}</td>
                                <td>NT$ ${payment.electricity_rate ? payment.electricity_rate.toLocaleString() : '--'}</td>
                                <td>${payment.previous_electricity ? payment.previous_electricity.toLocaleString() : '--'}</td>
                                <td>${payment.current_electricity ? payment.current_electricity.toLocaleString() : '--'}</td>
                                <td>${payment.electricity_usage || '--'}</td>
                                <td><strong>NT$ ${payment.total_amount ? payment.total_amount.toLocaleString() : '--'}</strong></td>
                                <td>${escapeHtml(payment.account_last_five || '--')}</td>
                                <td>
                                    <span class="status-badge ${payment.status === 'confirmed' ? 'status-confirmed' : 'status-pending'}">
                                        ${payment.status === 'confirmed' ? '已確認' : '待確認'}
                                    </span>
                                </td>
                                <td>
                                    <div class="action-btns">
                                        <button class="action-btn action-btn-view" onclick="viewPaymentDetails(${payment.id})">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        ${payment.status === 'pending' ? `
                                            <button class="action-btn action-btn-confirm" onclick="confirmPayment(${payment.id})">
                                                <i class="fas fa-check"></i> 確認
                                            </button>
                                            <button class="action-btn action-btn-delete" onclick="deletePayment(${payment.id})">
                                                <i class="fas fa-trash"></i> 刪除
                                            </button>
                                        ` : ''}
                                    </div>
                                </td>
                            </tr>
                        `).join('');
                        
                        // 更新統計資訊
                        updatePaymentStats(response.data.stats || {});
                        
                        // 顯示分頁控制
                        if (totalPaymentPages > 1) {
                            renderPaymentPagination();
                        }
                    } else {
                        if (emptyEl) emptyEl.style.display = 'block';
                    }
                } else {
                    if (emptyEl) emptyEl.style.display = 'block';
                    showAlert('載入繳費記錄失敗: ' + (response.message || '未知錯誤'), 'error');
                }
            } catch (error) {
                console.error('載入繳費記錄失敗:', error);
                if (loadingEl) loadingEl.style.display = 'none';
                showAlert('載入繳費記錄失敗，請稍後再試', 'error');
            }
        }
        
        // 更新繳費統計資訊
        function updatePaymentStats(stats) {
            if (stats.total_payments !== undefined) {
                document.getElementById('totalPayments').textContent = stats.total_payments.toLocaleString();
            }
            if (stats.pending_payments !== undefined) {
                document.getElementById('pendingPayments').textContent = stats.pending_payments.toLocaleString();
            }
            if (stats.confirmed_payments !== undefined) {
                document.getElementById('confirmedPayments').textContent = stats.confirmed_payments.toLocaleString();
            }
            if (stats.total_amount !== undefined) {
                document.getElementById('totalAmount').textContent = `NT$ ${stats.total_amount.toLocaleString()}`;
            }
        }
        
        // 渲染繳費記錄分頁
        function renderPaymentPagination() {
            const paginationEl = document.getElementById('paymentPagination');
            if (!paginationEl) return;
            
            paginationEl.style.display = 'flex';
            
            let paginationHtml = '';
            
            // 上一頁按鈕
            paginationHtml += `
                <button class="page-btn" onclick="loadPaymentsWithPagination(${currentPaymentPage - 1})" 
                        ${currentPaymentPage <= 1 ? 'disabled' : ''}>
                    <i class="fas fa-chevron-left"></i> 上一頁
                </button>
            `;
            
            // 頁碼按鈕
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPaymentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPaymentPages, startPage + maxVisiblePages - 1);
            
            // 調整起始頁
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // 第一頁和省略號
            if (startPage > 1) {
                paginationHtml += `<button class="page-btn" onclick="loadPaymentsWithPagination(1)">1</button>`;
                if (startPage > 2) {
                    paginationHtml += `<span class="page-dots">...</span>`;
                }
            }
            
            // 頁碼
            for (let i = startPage; i <= endPage; i++) {
                paginationHtml += `
                    <button class="page-btn ${i === currentPaymentPage ? 'active' : ''}" 
                            onclick="loadPaymentsWithPagination(${i})">
                        ${i}
                    </button>
                `;
            }
            
            // 最後一頁和省略號
            if (endPage < totalPaymentPages) {
                if (endPage < totalPaymentPages - 1) {
                    paginationHtml += `<span class="page-dots">...</span>`;
                }
                paginationHtml += `
                    <button class="page-btn" onclick="loadPaymentsWithPagination(${totalPaymentPages})">
                        ${totalPaymentPages}
                    </button>
                `;
            }
            
            // 下一頁按鈕
            paginationHtml += `
                <button class="page-btn" onclick="loadPaymentsWithPagination(${currentPaymentPage + 1})" 
                        ${currentPaymentPage >= totalPaymentPages ? 'disabled' : ''}>
                    下一頁 <i class="fas fa-chevron-right"></i>
                </button>
            `;
            
            // 頁碼資訊
            paginationHtml += `
                <div class="page-info">
                    第 ${currentPaymentPage} 頁 / 共 ${totalPaymentPages} 頁
                </div>
            `;
            
            paginationEl.innerHTML = paginationHtml;
        }
        
        // 查看繳費詳細資訊
        async function viewPaymentDetails(paymentId) {
            try {
                const response = await api.adminApi.getPaymentDetails(paymentId);
                
                if (response.success && response.data) {
                    const payment = response.data;
                    
                    // 創建並顯示詳細資訊模態框
                    const modalHtml = `
                        <div class="modal active" id="paymentDetailsModal">
                            <div class="modal-content" style="max-width: 700px;">
                                <div class="modal-header">
                                    <h3><i class="fas fa-file-invoice-dollar"></i> 繳費記錄詳細資訊</h3>
                                    <button class="modal-close" onclick="closeModal('paymentDetailsModal')">&times;</button>
                                </div>
                                <div class="modal-body">
                                    <div class="detail-item">
                                        <div class="detail-label">租客姓名</div>
                                        <div class="detail-value">${escapeHtml(payment.tenant_name || '--')}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">房號</div>
                                        <div class="detail-value">${escapeHtml(payment.room_number || '--')}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">繳費日期</div>
                                        <div class="detail-value">${payment.payment_date ? formatDate(payment.payment_date) : '--'}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">房租</div>
                                        <div class="detail-value">NT$ ${payment.rent_amount ? payment.rent_amount.toLocaleString() : '--'}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">水費</div>
                                        <div class="detail-value">NT$ ${payment.water_fee ? payment.water_fee.toLocaleString() : '--'}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">電費單價</div>
                                        <div class="detail-value">NT$ ${payment.electricity_rate ? payment.electricity_rate.toLocaleString() : '--'} / 度</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">上期電表</div>
                                        <div class="detail-value">${payment.previous_electricity ? payment.previous_electricity.toLocaleString() : '--'}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">本期電表</div>
                                        <div class="detail-value">${payment.current_electricity ? payment.current_electricity.toLocaleString() : '--'}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">用電度數</div>
                                        <div class="detail-value">${payment.electricity_usage || '--'} 度</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">電費小計</div>
                                        <div class="detail-value">NT$ ${payment.electricity_fee ? payment.electricity_fee.toLocaleString() : '--'}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">其他費用</div>
                                        <div class="detail-value">NT$ ${payment.other_fees ? payment.other_fees.toLocaleString() : '--'}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">總金額</div>
                                        <div class="detail-value"><strong>NT$ ${payment.total_amount ? payment.total_amount.toLocaleString() : '--'}</strong></div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">匯款帳號後五碼</div>
                                        <div class="detail-value">${escapeHtml(payment.account_last_five || '--')}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">狀態</div>
                                        <div class="detail-value">
                                            <span class="status-badge ${payment.status === 'confirmed' ? 'status-confirmed' : 'status-pending'}">
                                                ${payment.status === 'confirmed' ? '已確認' : '待確認'}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">備註</div>
                                        <div class="detail-value">${escapeHtml(payment.notes || '無')}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">建立時間</div>
                                        <div class="detail-value">${payment.created_at ? formatDate(payment.created_at, true) : '--'}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">最後更新時間</div>
                                        <div class="detail-value">${payment.updated_at ? formatDate(payment.updated_at, true) : '--'}</div>
                                    </div>
                                    
                                    ${payment.images && payment.images.length > 0 ? `
                                        <div class="detail-item">
                                            <div class="detail-label">上傳圖片</div>
                                            <div class="detail-value">
                                                <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                                                    ${payment.images.map(img => `
                                                        <img src="${img.image_url}" alt="繳費證明" 
                                                             style="width: 100px; height: 100px; object-fit: cover; border-radius: 5px; cursor: pointer;"
                                                             onclick="previewImage('${img.image_url}', '${img.file_name || '繳費證明'}', '${escapeHtml(payment.tenant_name || '租客')}', '${img.uploaded_at ? formatDate(img.uploaded_at, true) : ''}')">
                                                    `).join('')}
                                                </div>
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    <div style="margin-top: 20px; text-align: center;">
                                        ${payment.status === 'pending' ? `
                                            <button class="btn btn-success" onclick="confirmPayment(${payment.id}, true)">
                                                <i class="fas fa-check"></i> 確認此筆繳費
                                            </button>
                                        ` : ''}
                                        <button class="btn btn-secondary" onclick="closeModal('paymentDetailsModal')" style="margin-left: 10px;">
                                            <i class="fas fa-times"></i> 關閉
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // 添加模態框到頁面
                    const modalContainer = document.createElement('div');
                    modalContainer.innerHTML = modalHtml;
                    document.body.appendChild(modalContainer);
                } else {
                    showAlert('獲取繳費詳細資訊失敗: ' + (response.message || '未知錯誤'), 'error');
                }
            } catch (error) {
                console.error('查看繳費詳細資訊失敗:', error);
                showAlert('獲取詳細資訊失敗，請稍後再試', 'error');
            }
        }
        
        // 確認繳費
        async function confirmPayment(paymentId, reload = false) {
            if (!confirm('確定要確認這筆繳費嗎？確認後將無法撤銷。')) {
                return;
            }
            
            try {
                const response = await api.adminApi.confirmPayment(paymentId);
                
                if (response.success) {
                    showAlert('繳費確認成功', 'success');
                    
                    // 關閉模態框（如果存在）
                    closeModal('paymentDetailsModal');
                    
                    // 重新載入資料
                    if (reload) {
                        loadPaymentsWithPagination(currentPaymentPage);
                    } else {
                        // 只更新當前行的狀態
                        const row = document.querySelector(`tr[data-payment-id="${paymentId}"]`);
                        if (row) {
                            const statusCell = row.querySelector('td:nth-child(12)');
                            if (statusCell) {
                                statusCell.innerHTML = '<span class="status-badge status-confirmed">已確認</span>';
                            }
                            
                            const actionCell = row.querySelector('td:nth-child(13)');
                            if (actionCell) {
                                actionCell.innerHTML = '<div class="action-btns"><button class="action-btn action-btn-view" onclick="viewPaymentDetails(' + paymentId + ')"><i class="fas fa-eye"></i></button></div>';
                            }
                        }
                    }
                } else {
                    showAlert('確認失敗: ' + (response.message || '未知錯誤'), 'error');
                }
            } catch (error) {
                console.error('確認繳費失敗:', error);
                showAlert('確認失敗，請稍後再試', 'error');
            }
        }
        
        // 刪除繳費記錄
        async function deletePayment(paymentId) {
            if (!confirm('確定要刪除這筆繳費記錄嗎？此操作無法復原。')) {
                return;
            }
            
            try {
                const response = await api.adminApi.deletePayment(paymentId);
                
                if (response.success) {
                    showAlert('繳費記錄刪除成功', 'success');
                    // 重新載入資料
                    loadPaymentsWithPagination(currentPaymentPage);
                } else {
                    showAlert('刪除失敗: ' + (response.message || '未知錯誤'), 'error');
                }
            } catch (error) {
                console.error('刪除繳費記錄失敗:', error);
                showAlert('刪除失敗，請稍後再試', 'error');
            }
        }
        
        // 載入圖片（帶分頁）
        let currentImagePage = 1;
        let totalImagePages = 1;
        
        async function loadImagesWithPagination(page = 1) {
            currentImagePage = page;
            
            const loadingEl = document.getElementById('imagesLoading');
            const emptyEl = document.getElementById('imagesEmpty');
            const imagesGrid = document.getElementById('imagesGrid');
            const paginationEl = document.getElementById('imagePagination');
            
            if (loadingEl) loadingEl.style.display = 'flex';
            if (emptyEl) emptyEl.style.display = 'none';
            if (imagesGrid) imagesGrid.innerHTML = '';
            if (paginationEl) paginationEl.style.display = 'none';
            
            try {
                // 獲取篩選條件
                const filters = {
                    page: page,
                    tenant_id: document.getElementById('imageTenantFilter').value === 'all' ? null : document.getElementById('imageTenantFilter').value,
                    search: document.getElementById('imageSearch').value.trim()
                };
                
                const response = await api.adminPaginatedApi.getImages(filters);
                
                if (loadingEl) loadingEl.style.display = 'none';
                
                if (response.success && response.data) {
                    const images = response.data.images || response.data.data || [];
                    totalImagePages = response.data.total_pages || 1;
                    
                    if (images.length > 0) {
                        // 填充圖片網格
                        imagesGrid.innerHTML = images.map(img => `
                            <div class="image-card">
                                <img src="${img.image_url}" alt="${img.file_name || '圖片'}" 
                                     class="image-preview"
                                     onclick="previewImage('${img.image_url}', '${img.file_name || '未命名'}', '${escapeHtml(img.tenant_name || '未知租客')}', '${img.uploaded_at ? formatDate(img.uploaded_at, true) : ''}', '${img.file_size ? formatFileSize(img.file_size) : ''}')"
                                     onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"400\" height=\"300\"><rect width=\"400\" height=\"300\" fill=\"%23f0f0f0\"/><text x=\"50%\" y=\"50%\" text-anchor=\"middle\" dy=\".3em\" font-family=\"Arial\" font-size=\"14\" fill=\"%23999\">圖片無法載入</text></svg>'">
                                <div class="image-info">
                                    <h4 title="${img.file_name || '未命名'}">${truncateFileName(img.file_name || '未命名')}</h4>
                                    <p><i class="fas fa-user"></i> ${escapeHtml(img.tenant_name || '未知租客')}</p>
                                    <p><i class="fas fa-home"></i> ${escapeHtml(img.room_number || '--')}</p>
                                    <p><i class="fas fa-calendar"></i> ${img.uploaded_at ? formatDate(img.uploaded_at, true) : '未知時間'}</p>
                                    ${img.file_size ? `<p><i class="fas fa-weight"></i> ${formatFileSize(img.file_size)}</p>` : ''}
                                    <div class="image-actions">
                                        <button class="action-btn action-btn-download" onclick="downloadImage('${img.image_url}', '${img.file_name || 'image.jpg'}')">
                                            <i class="fas fa-download"></i> 下載
                                        </button>
                                        <button class="action-btn action-btn-delete" onclick="deleteImage(${img.id})">
                                            <i class="fas fa-trash"></i> 刪除
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                        
                        // 顯示分頁控制
                        if (totalImagePages > 1) {
                            renderImagePagination();
                        }
                    } else {
                        if (emptyEl) emptyEl.style.display = 'block';
                    }
                } else {
                    if (emptyEl) emptyEl.style.display = 'block';
                    showAlert('載入圖片失敗: ' + (response.message || '未知錯誤'), 'error');
                }
            } catch (error) {
                console.error('載入圖片失敗:', error);
                if (loadingEl) loadingEl.style.display = 'none';
                showAlert('載入圖片失敗，請稍後再試', 'error');
            }
        }
        
        // 渲染圖片分頁
        function renderImagePagination() {
            const paginationEl = document.getElementById('imagePagination');
            if (!paginationEl) return;
            
            paginationEl.style.display = 'flex';
            
            let paginationHtml = '';
            
            // 上一頁按鈕
            paginationHtml += `
                <button class="page-btn" onclick="loadImagesWithPagination(${currentImagePage - 1})" 
                        ${currentImagePage <= 1 ? 'disabled' : ''}>
                    <i class="fas fa-chevron-left"></i> 上一頁
                </button>
            `;
            
            // 頁碼按鈕
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentImagePage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalImagePages, startPage + maxVisiblePages - 1);
            
            // 調整起始頁
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // 第一頁和省略號
            if (startPage > 1) {
                paginationHtml += `<button class="page-btn" onclick="loadImagesWithPagination(1)">1</button>`;
                if (startPage > 2) {
                    paginationHtml += `<span class="page-dots">...</span>`;
                }
            }
            
            // 頁碼
            for (let i = startPage; i <= endPage; i++) {
                paginationHtml += `
                    <button class="page-btn ${i === currentImagePage ? 'active' : ''}" 
                            onclick="loadImagesWithPagination(${i})">
                        ${i}
                    </button>
                `;
            }
            
            // 最後一頁和省略號
            if (endPage < totalImagePages) {
                if (endPage < totalImagePages - 1) {
                    paginationHtml += `<span class="page-dots">...</span>`;
                }
                paginationHtml += `
                    <button class="page-btn" onclick="loadImagesWithPagination(${totalImagePages})">
                        ${totalImagePages}
                    </button>
                `;
            }
            
            // 下一頁按鈕
            paginationHtml += `
                <button class="page-btn" onclick="loadImagesWithPagination(${currentImagePage + 1})" 
                        ${currentImagePage >= totalImagePages ? 'disabled' : ''}>
                    下一頁 <i class="fas fa-chevron-right"></i>
                </button>
            `;
            
            // 頁碼資訊
            paginationHtml += `
                <div class="page-info">
                    第 ${currentImagePage} 頁 / 共 ${totalImagePages} 頁
                </div>
            `;
            
            paginationEl.innerHTML = paginationHtml;
        }
        
        // 刪除圖片
        async function deleteImage(imageId) {
            if (!confirm('確定要刪除這張圖片嗎？此操作無法復原。')) {
                return;
            }
            
            try {
                const response = await api.adminApi.deleteImage(imageId);
                
                if (response.success) {
                    showAlert('圖片刪除成功', 'success');
                    // 重新載入資料
                    loadImagesWithPagination(currentImagePage);
                } else {
                    showAlert('刪除失敗: ' + (response.message || '未知錯誤'), 'error');
                }
            } catch (error) {
                console.error('刪除圖片失敗:', error);
                showAlert('刪除失敗，請稍後再試', 'error');
            }
        }
        
        // 重置繳費記錄篩選器
        function resetPaymentFilters() {
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('tenantFilter').value = 'all';
            document.getElementById('paymentSearch').value = '';
            loadPaymentsWithPagination(1);
        }
        
        // 重置圖片篩選器
        function resetImageFilters() {
            document.getElementById('imageTenantFilter').value = 'all';
            document.getElementById('imageSearch').value = '';
            loadImagesWithPagination(1);
        }
        
        // 預覽圖片（新版本）
        function previewImage(imageUrl, fileName, tenantName, uploadDate, fileSize) {
            const modal = document.getElementById('imagePreviewModal');
            const previewImage = document.getElementById('previewImage');
            const previewImageInfo = document.getElementById('previewImageInfo');
            
            previewImage.src = imageUrl;
            previewImageInfo.innerHTML = `
                <div><strong>檔案名稱：</strong>${escapeHtml(fileName || '未命名')}</div>
                <div><strong>上傳者：</strong>${escapeHtml(tenantName || '未知租客')}</div>
                <div><strong>上傳時間：</strong>${uploadDate || '未知時間'}</div>
                ${fileSize ? `<div><strong>檔案大小：</strong>${fileSize}</div>` : ''}
            `;
            
            modal.classList.add('active');
        }
        
        // 下載預覽的圖片
        function downloadPreviewImage() {
            const previewImage = document.getElementById('previewImage');
            const imageUrl = previewImage.src;
            const fileName = imageUrl.substring(imageUrl.lastIndexOf('/') + 1) || 'image.jpg';
            downloadImage(imageUrl, fileName);
        }
        
        // 通用下載圖片函數
        function downloadImage(imageUrl, fileName) {
            try {
                const link = document.createElement('a');
                link.href = imageUrl;
                link.download = fileName || 'image.jpg';
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showAlert('開始下載圖片', 'success');
            } catch (error) {
                console.error('下載圖片失敗:', error);
                showAlert('下載失敗，請手動保存圖片', 'error');
            }
        }
        
        // 顯示提示訊息
        function showAlert(message, type = 'info') {
            const alertEl = document.getElementById('alertMessage');
            if (!alertEl) return;
            
            alertEl.textContent = message;
            alertEl.className = `alert alert-${type}`;
            alertEl.style.display = 'block';
            
            // 自動隱藏
            setTimeout(() => {
                alertEl.style.display = 'none';
            }, 5000);
        }
        
        // 登出
        function logout() {
            if (api && api.userApi && typeof api.userApi.logout === 'function') {
                api.userApi.logout();
            }
            window.location.href = 'login.html';
        }
        
        // 關閉模態框
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.remove();
            }
        }
        
        // 切換標籤頁
        function switchTab(tabName) {
            // 移除所有標籤頁的 active 類別
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 添加 active 類別到目標標籤頁
            const tabButtons = document.querySelectorAll('.tab-btn');
            tabButtons.forEach(btn => {
                if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(tabName)) {
                    btn.classList.add('active');
                }
            });
            
            const tabContent = document.getElementById(tabName + 'Tab');
            if (tabContent) {
                tabContent.classList.add('active');
            }
            
            // 根據標籤頁載入資料
            switch(tabName) {
                case 'tenants':
                    loadAllTenants();
                    break;
                case 'payments':
                    loadPaymentsWithPagination(1);
                    break;
                case 'images':
                    loadImagesWithPagination(1);
                    break;
                case 'bank':
                    loadBankInfo();
                    break;
            }
        }
        
        // 格式化日期
        function formatDate(dateString, includeTime = false) {
            if (!dateString) return '--';
            
            try {
                const date = new Date(dateString);
                
                if (isNaN(date.getTime())) {
                    return '日期格式錯誤';
                }
                
                if (includeTime) {
                    return date.toLocaleString('zh-TW', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                }
                
                return date.toLocaleDateString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            } catch (error) {
                return '日期錯誤';
            }
        }
        
        // 格式化檔案大小
        function formatFileSize(bytes) {
            if (!bytes || bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // 跳脫 HTML 字元
        function escapeHtml(text) {
            if (!text) return '';
            
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            
            return text.toString().replace(/[&<>"']/g, function(m) { 
                return map[m]; 
            });
        }
        
        // 截斷檔案名稱
        function truncateFileName(fileName, maxLength = 20) {
            if (!fileName || fileName.length <= maxLength) return fileName || '未命名';
            
            const extension = fileName.substring(fileName.lastIndexOf('.'));
            const nameWithoutExtension = fileName.substring(0, fileName.lastIndexOf('.'));
            
            if (nameWithoutExtension.length <= maxLength - 3) return fileName;
            
            return nameWithoutExtension.substring(0, maxLength - 3) + '...' + extension;
        }
    </script>
</body>
</html>